# 🚀 手链运势小程序 - 部署总览

## 📋 我为你准备的所有文件

```
deployment/
├── README.md                      # 详细部署文档
├── QUICK_START.md                 # 5分钟快速开始
├── 部署总览.md                    # 本文件
├── check-server-env.sh            # 环境检查脚本
├── install-dependencies.sh        # 依赖安装脚本
├── deploy-backend.sh              # 后端部署脚本
├── setup-cpolar.sh                # cpolar配置脚本
├── deploy-all.sh                  # 一键部署脚本
└── .env.production.template       # 环境变量模板
```

---

## 🎯 部署方案

### 当前方案：使用cpolar临时测试

```
服务器（47.239.179.9）
    ↓
后端API（端口3000）
    ↓
cpolar内网穿透
    ↓
生成HTTPS地址（例如：https://abc123.r1.cpolar.top）
    ↓
微信小程序访问
```

**优势：**

- ✅ 立即可用，无需等待备案
- ✅ 支持HTTPS，满足微信要求
- ✅ 可以真机测试所有功能

**限制：**

- ⚠️ 免费版地址每天变化
- ⚠️ 只能用于测试，不能正式发布

---

## 📝 你需要提供的信息

### 1. 微信小程序密钥（必须）

```
获取地址：https://mp.weixin.qq.com
路径：开发 → 开发管理 → 开发设置 → 开发者ID
需要：AppSecret
```

### 2. cpolar账号（必须）

```
注册地址：https://dashboard.cpolar.com/signup
需要：Authtoken（注册后在首页获取）
```

### 3. AI服务密钥（可选但推荐）

```
推荐服务：
- 火山引擎（豆包）：https://console.volcengine.com/ark
- DeepSeek：https://platform.deepseek.com/
- OpenAI：https://platform.openai.com/

如果没有：系统会使用随机生成的运势（体验较差）
```

---

## 🚀 部署流程

### 方案A：快速部署（推荐新手）

**阅读文档：** `QUICK_START.md`

**时间：** 5-10分钟

**步骤：**

1. 获取微信密钥和cpolar账号
2. 上传部署脚本到服务器
3. 运行一键部署脚本
4. 修改小程序配置
5. 编译上传体验版

### 方案B：详细部署（推荐有经验者）

**阅读文档：** `README.md`

**时间：** 20-30分钟

**步骤：**

1. 检查服务器环境
2. 安装必要依赖
3. 配置环境变量
4. 部署后端API
5. 配置cpolar
6. 测试服务
7. 配置小程序
8. 上传体验版

---

## 📂 服务器信息汇总

### SSH连接信息

```bash
地址：47.239.179.9
端口：43122
用户：xiaoyi-dev1
密码：n6pCTKmpXDGVSjhfMzbX

# 连接命令
ssh xiaoyi-dev1@47.239.179.9 -p 43122
```

### 数据库信息

```bash
数据库名：bracelet-fortune
用户名：bracelet-fortune
密码：HvXFmwEwfntnScWZRJyB

# 内部连接（推荐）
地址：1Panel-postgresql-0i7g
端口：5432

# 外部连接（备用）
地址：47.239.179.9
端口：15432

# 连接字符串（内部）
DATABASE_URL="postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@1Panel-postgresql-0i7g:5432/bracelet-fortune?schema=public"

# 连接字符串（外部）
DATABASE_URL="postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@47.239.179.9:15432/bracelet-fortune?schema=public"
```

### 小程序信息

```bash
AppID：wx7ba4129d919fdf01
AppSecret：需要你提供
域名：xiaoweigezzz.xyz（暂不可用，需备案）
```

---

## 🛠️ 我能帮你做什么

### ✅ 已经帮你准备好的：

1. **完整的部署脚本**
   - 环境检查脚本
   - 依赖安装脚本
   - 后端部署脚本
   - cpolar配置脚本
   - 一键部署脚本

2. **配置文件模板**
   - 环境变量模板（.env）
   - 包含所有必要配置项
   - 详细的注释说明

3. **详细的文档**
   - 快速开始指南
   - 完整部署文档
   - 常见问题解答

### 🤝 你需要做的：

1. **提供必要信息**
   - 微信小程序密钥
   - cpolar账号token
   - AI服务密钥（可选）

2. **执行部署命令**
   - 复制粘贴命令到服务器
   - 按照提示操作

3. **配置小程序**
   - 修改2个配置文件
   - 编译上传

---

## 📋 部署检查清单

### 部署前

- [ ] 已获取微信小程序密钥（WECHAT_APP_SECRET）
- [ ] 已注册cpolar账号并获取authtoken
- [ ] 已准备AI服务密钥（可选）
- [ ] 已连接到服务器

### 部署中

- [ ] 已上传部署脚本到服务器
- [ ] 已上传项目代码到服务器
- [ ] 已运行一键部署脚本
- [ ] 已配置环境变量
- [ ] 后端服务启动成功（pm2 status显示online）
- [ ] cpolar服务启动成功
- [ ] 已获取cpolar公网地址

### 部署后

- [ ] 已修改小程序配置（TUNNEL_BASE_URL）
- [ ] 已关闭开发模式（DEV_CONFIG.enabled = false）
- [ ] 已编译小程序（pnpm build:mp-weixin）
- [ ] 已在微信公众平台配置域名
- [ ] 已上传体验版
- [ ] 已在真机测试成功

---

## 🧪 测试清单

### 后端API测试

```bash
# 在服务器上测试
curl http://localhost:3000

# 测试cpolar公网访问
curl https://你的cpolar地址.r1.cpolar.top
```

### 小程序功能测试

- [ ] 打开小程序（首页显示正常）
- [ ] 点击绑定手链（微信登录成功）
- [ ] 填写个人信息（保存成功）
- [ ] 查看运势（运势生成成功）
- [ ] 查看历史记录（历史数据显示正常）
- [ ] 点击商品推荐（跳转正常）

---

## ⚠️ 重要提醒

### 关于cpolar免费版

```
限制：
- 地址每天会变化
- 需要每天更新小程序配置和微信公众平台域名

解决方案：
1. 升级付费版（9元/月，固定地址）
2. 或等待域名备案完成后切换到正式域名
```

### 关于域名备案

```
你的域名：xiaoweigezzz.xyz
状态：未备案，无法用于小程序

建议：
1. 购买 .com 或 .cn 域名
2. 提交ICP备案（1-20个工作日）
3. 备案完成后切换到正式域名
```

### 关于AI服务

```
如果没有AI服务密钥：
- 运势会使用随机生成
- 功能可以正常使用
- 但体验会较差

建议：
申请一个AI服务账号（推荐火山引擎豆包，便宜好用）
```

---

## 📞 获取帮助

### 查看日志

```bash
# 后端日志
pm2 logs bracelet-api

# cpolar日志
sudo journalctl -u cpolar -f

# 系统日志
sudo journalctl -xe
```

### 常用命令

```bash
# 查看服务状态
pm2 status
sudo systemctl status cpolar

# 重启服务
pm2 restart bracelet-api
sudo systemctl restart cpolar

# 查看cpolar地址
cpolar status
cat ~/cpolar-url.txt
```

---

## 🎯 下一步计划

### 短期（使用cpolar测试）

1. ✅ 完成部署
2. ✅ 真机测试所有功能
3. ✅ 发现并修复问题
4. ✅ 优化用户体验

### 中期（申请域名备案）

1. 购买 .com 或 .cn 域名
2. 提交ICP备案申请
3. 等待备案通过（1-20个工作日）
4. 继续使用cpolar测试

### 长期（正式上线）

1. 配置正式域名
2. 配置SSL证书
3. 修改小程序配置
4. 提交审核
5. 正式发布

---

## 📚 文档索引

| 文档             | 用途          | 适合人群 |
| ---------------- | ------------- | -------- |
| `QUICK_START.md` | 5分钟快速部署 | 新手     |
| `README.md`      | 详细部署文档  | 所有人   |
| `部署总览.md`    | 本文件，总览  | 所有人   |

---

## ✅ 准备好了吗？

### 如果你是新手：

**开始阅读：** `QUICK_START.md`

### 如果你有经验：

**开始阅读：** `README.md`

### 如果遇到问题：

1. 查看日志
2. 检查配置
3. 阅读常见问题
4. 寻求帮助

---

**祝你部署顺利！** 🚀

有任何问题随时问我！
