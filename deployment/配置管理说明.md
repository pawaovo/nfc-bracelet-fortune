# 🔐 配置管理说明

## 📋 问题解答

### Q1: 开发阶段已经填入了密钥，部署时怎么办？

**答案：开发配置和生产配置是分离的，互不影响。**

---

## 🎯 配置管理策略

### 1. 开发环境配置（本地）

**位置：** `apps/api/.env`（本地电脑）

**内容：** 你的开发配置

```env
# 开发数据库（本地）
DATABASE_URL="postgresql://postgres:123456@localhost:5432/nfc_bracelet_fortune?schema=public"

# 开发JWT密钥
JWT_SECRET="nfc-bracelet-fortune-jwt-secret-2024-dev-key-change-in-production"

# 微信小程序配置（开发）
WECHAT_APP_ID="wx35698b4e9c2f6afe"
WECHAT_APP_SECRET="b36c2b532f180193d9e2a0839ec100f3"

# AI服务配置（开发）
OPENAI_API_KEY="732372aa-8401-4d91-b9c2-47726252d6ee"
OPENAI_BASE_URL="https://ark.cn-beijing.volces.com/api/v3"
OPENAI_MODEL="doubao-seed-1-6-flash-250828"

# 开发环境
NODE_ENV="development"
```

**特点：**

- ✅ 保存在本地
- ✅ 不会上传到服务器（`.gitignore` 已排除）
- ✅ 用于本地开发和测试

---

### 2. 生产环境配置（服务器）

**位置：** `apps/api/.env`（服务器）

**内容：** 生产配置（部署时创建）

```env
# 生产数据库（服务器）
DATABASE_URL="postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@1Panel-postgresql-0i7g:5432/bracelet-fortune?schema=public"

# 生产JWT密钥（随机生成）
JWT_SECRET="生成的随机字符串"

# 微信小程序配置（生产）
WECHAT_APP_ID="wx7ba4129d919fdf01"  # 正式小程序AppID
WECHAT_APP_SECRET="你的正式小程序密钥"

# AI服务配置（生产）
OPENAI_API_KEY="你的AI服务密钥"
OPENAI_BASE_URL="https://ark.cn-beijing.volces.com/api/v3"
OPENAI_MODEL="doubao-seed-1-6-lite-251015"

# 生产环境
NODE_ENV="production"
```

**特点：**

- ✅ 只存在于服务器
- ✅ 使用生产数据库
- ✅ 使用正式小程序AppID
- ✅ 使用更安全的JWT密钥

---

## 🔄 部署流程中的配置处理

### 步骤1：上传项目代码

**使用脚本：** `upload-project.ps1`

**处理方式：**

```
✅ 上传源代码
✅ 上传配置文件模板
❌ 不上传 .env 文件（自动排除）
❌ 不上传 node_modules
❌ 不上传编译产物
```

**结果：**

- 你的开发配置（`.env`）保留在本地
- 服务器上没有 `.env` 文件

---

### 步骤2：运行部署脚本

**使用脚本：** `deploy-all.sh`

**处理方式：**

```bash
# 检查是否存在 .env 文件
if [ -f "$ENV_FILE" ]; then
    # 如果存在，询问是否覆盖
    # 如果不覆盖，保留现有配置
else
    # 如果不存在，从模板创建
    cp .env.production.template .env
fi
```

**结果：**

- 在服务器上创建新的 `.env` 文件
- 使用生产环境配置模板

---

### 步骤3：填写生产配置

**需要填写的信息：**

1. **JWT_SECRET**（必须修改）

   ```bash
   # 生成随机字符串
   node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
   ```

2. **WECHAT_APP_SECRET**（必须填写）
   - 登录微信公众平台
   - 获取正式小程序的AppSecret

3. **OPENAI_API_KEY**（可选但推荐）
   - 填写你的AI服务密钥
   - 如果没有，系统会使用随机运势

---

## 📊 配置对比

| 配置项          | 开发环境（本地）           | 生产环境（服务器）          |
| --------------- | -------------------------- | --------------------------- |
| **数据库**      | localhost:5432             | 1Panel-postgresql-0i7g:5432 |
| **JWT密钥**     | 开发用密钥                 | 随机生成的安全密钥          |
| **小程序AppID** | wx35698b4e9c2f6afe（开发） | wx7ba4129d919fdf01（正式）  |
| **小程序密钥**  | 开发密钥                   | 正式密钥                    |
| **AI模型**      | flash（快速）              | lite（稳定）                |
| **NODE_ENV**    | development                | production                  |

---

## 🔒 安全性说明

### 为什么不上传 .env 文件？

1. **保护开发配置**
   - 开发配置包含本地数据库密码
   - 不应该暴露给服务器

2. **避免配置混淆**
   - 开发和生产使用不同的配置
   - 分离管理更安全

3. **符合最佳实践**
   - `.env` 文件应该在 `.gitignore` 中
   - 每个环境独立配置

---

## 📝 实际操作示例

### 场景1：首次部署

```bash
# 1. 在本地运行上传脚本
.\deployment\upload-project.ps1

# 2. 连接到服务器
ssh xiaoyi-dev1@47.239.179.9 -p 43122

# 3. 解压项目
cd ~
unzip -o bracelet-fortune.zip -d bracelet-fortune

# 4. 运行部署脚本
cd ~/deployment
chmod +x *.sh
./deploy-all.sh

# 5. 部署脚本会提示：
# "环境变量文件不存在，是否创建？"
# 选择 y

# 6. 编辑配置文件
nano ~/bracelet-fortune/apps/api/.env

# 7. 修改以下配置：
# - JWT_SECRET（生成随机字符串）
# - WECHAT_APP_SECRET（填写正式密钥）
# - OPENAI_API_KEY（填写AI密钥）

# 8. 保存并继续部署
```

---

### 场景2：更新代码（已有配置）

```bash
# 1. 在本地运行上传脚本
.\deployment\upload-project.ps1

# 2. 连接到服务器
ssh xiaoyi-dev1@47.239.179.9 -p 43122

# 3. 解压项目（覆盖）
cd ~
unzip -o bracelet-fortune.zip -d bracelet-fortune

# 4. 运行部署脚本
cd ~/deployment
./deploy-all.sh

# 5. 部署脚本会提示：
# "环境变量文件已存在，是否覆盖？"
# 选择 n（保留现有配置）

# 6. 继续部署
# 配置不会被修改
```

---

## ⚠️ 重要提醒

### 1. 小程序AppID不同

**开发环境：** `wx35698b4e9c2f6afe`  
**生产环境：** `wx7ba4129d919fdf01`

**注意：**

- 这是两个不同的小程序
- 需要使用对应的AppSecret
- 不要混淆

### 2. 数据库不同

**开发环境：** 本地PostgreSQL  
**生产环境：** 服务器PostgreSQL

**注意：**

- 数据不会自动同步
- 需要单独管理

### 3. AI服务配置

**开发环境：** `doubao-seed-1-6-flash-250828`（快速）  
**生产环境：** `doubao-seed-1-6-lite-251015`（稳定）

**建议：**

- 开发用flash模型（响应快）
- 生产用lite模型（更稳定）

---

## 🎯 最佳实践

### 1. 配置文件管理

```
✅ 开发配置保存在本地
✅ 生产配置只存在于服务器
✅ 使用 .gitignore 排除 .env
✅ 使用模板文件（.env.template）
```

### 2. 密钥管理

```
✅ 开发密钥可以简单
✅ 生产密钥必须复杂
✅ 定期更换生产密钥
✅ 不要在代码中硬编码密钥
```

### 3. 部署流程

```
✅ 上传代码时排除 .env
✅ 在服务器上单独配置
✅ 备份现有配置
✅ 验证配置正确性
```

---

## 📞 常见问题

### Q: 我的开发配置会被上传吗？

**答：不会。**

`upload-project.ps1` 脚本会自动排除 `.env` 文件。

---

### Q: 服务器上的配置会覆盖我的开发配置吗？

**答：不会。**

服务器和本地是完全独立的环境。

---

### Q: 如果我想使用相同的AI密钥怎么办？

**答：可以。**

在服务器的 `.env` 文件中填写相同的 `OPENAI_API_KEY` 即可。

---

### Q: 如果我想在服务器上使用开发数据库怎么办？

**答：不建议。**

开发数据库在本地，服务器无法访问。应该使用服务器上的生产数据库。

---

## 📚 相关文档

- **快速开始：** `QUICK_START.md`
- **详细部署：** `README.md`
- **文件清单：** `我帮你准备的文件清单.md`

---

**总结：开发配置和生产配置是完全分离的，互不影响！** ✅
