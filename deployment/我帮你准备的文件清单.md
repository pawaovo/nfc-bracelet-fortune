# 📦 我帮你准备的所有文件

## 📋 文件清单

### 📚 文档类（3个）

| 文件名                    | 用途                             | 适合人群 |
| ------------------------- | -------------------------------- | -------- |
| `README.md`               | 详细部署文档，包含所有步骤和说明 | 所有人   |
| `QUICK_START.md`          | 5分钟快速开始指南                | 新手     |
| `部署总览.md`             | 部署方案总览和信息汇总           | 所有人   |
| `我帮你准备的文件清单.md` | 本文件，文件说明                 | 所有人   |

### 🔧 脚本类（5个）

| 文件名                    | 用途                             | 执行位置 |
| ------------------------- | -------------------------------- | -------- |
| `check-server-env.sh`     | 检查服务器环境是否满足要求       | 服务器   |
| `install-dependencies.sh` | 自动安装所有必要依赖             | 服务器   |
| `deploy-backend.sh`       | 部署后端API服务                  | 服务器   |
| `setup-cpolar.sh`         | 安装并配置cpolar内网穿透         | 服务器   |
| `deploy-all.sh`           | 一键部署脚本（调用上面所有脚本） | 服务器   |

### ⚙️ 配置类（1个）

| 文件名                     | 用途             |
| -------------------------- | ---------------- |
| `.env.production.template` | 生产环境变量模板 |

### 💻 本地工具（2个）

| 文件名                 | 用途                           | 执行位置 |
| ---------------------- | ------------------------------ | -------- |
| `upload-to-server.bat` | Windows批处理，上传部署脚本    | 本地电脑 |
| `upload-project.ps1`   | PowerShell脚本，打包并上传项目 | 本地电脑 |

---

## 🎯 使用指南

### 方案1：快速部署（推荐）

**适合：** 想快速完成部署的用户

**步骤：**

1. **阅读快速开始指南**

   ```
   打开：QUICK_START.md
   ```

2. **上传部署脚本**

   ```
   双击运行：upload-to-server.bat
   ```

3. **连接服务器并部署**
   ```bash
   ssh xiaoyi-dev1@47.239.179.9 -p 43122
   cd ~/deployment
   chmod +x *.sh
   ./deploy-all.sh
   ```

### 方案2：详细部署（推荐有经验者）

**适合：** 想了解每个步骤的用户

**步骤：**

1. **阅读详细文档**

   ```
   打开：README.md
   ```

2. **分步执行脚本**

   ```bash
   # 步骤1：检查环境
   ./check-server-env.sh

   # 步骤2：安装依赖
   ./install-dependencies.sh

   # 步骤3：部署后端
   ./deploy-backend.sh

   # 步骤4：配置cpolar
   ./setup-cpolar.sh
   ```

---

## 📝 每个文件的详细说明

### 1. README.md

**内容：**

- 部署概览
- 部署前准备
- 详细部署步骤
- 配置小程序
- 测试指南
- 常用命令
- 常见问题

**何时使用：**

- 第一次部署时完整阅读
- 遇到问题时查阅

### 2. QUICK_START.md

**内容：**

- 5分钟快速部署流程
- 最简化的步骤
- 快速测试方法

**何时使用：**

- 想快速完成部署
- 不想了解太多细节

### 3. 部署总览.md

**内容：**

- 所有文件说明
- 服务器信息汇总
- 部署方案说明
- 检查清单
- 下一步计划

**何时使用：**

- 了解整体部署方案
- 查看服务器信息
- 检查部署进度

### 4. check-server-env.sh

**功能：**

- 检查Node.js版本
- 检查npm/pnpm
- 检查PM2
- 检查Nginx
- 测试数据库连接
- 检查磁盘空间
- 检查端口占用

**使用方法：**

```bash
cd ~/deployment
chmod +x check-server-env.sh
./check-server-env.sh
```

### 5. install-dependencies.sh

**功能：**

- 安装Node.js 20.x
- 安装pnpm
- 安装PM2
- 安装PostgreSQL客户端（可选）
- 安装Nginx（可选）

**使用方法：**

```bash
cd ~/deployment
chmod +x install-dependencies.sh
./install-dependencies.sh
```

### 6. deploy-backend.sh

**功能：**

- 安装项目依赖
- 生成Prisma客户端
- 运行数据库迁移
- 编译后端代码
- 复制文件到生产目录
- 使用PM2启动服务
- 设置开机自启

**使用方法：**

```bash
cd ~/deployment
chmod +x deploy-backend.sh
./deploy-backend.sh
```

### 7. setup-cpolar.sh

**功能：**

- 下载并安装cpolar
- 配置authtoken
- 创建配置文件
- 创建systemd服务
- 启动cpolar
- 获取公网地址

**使用方法：**

```bash
cd ~/deployment
chmod +x setup-cpolar.sh
./setup-cpolar.sh
```

**需要准备：**

- cpolar账号的authtoken

### 8. deploy-all.sh

**功能：**

- 自动执行所有部署步骤
- 包含交互式提示
- 自动检测和跳过已完成的步骤

**使用方法：**

```bash
cd ~/deployment
chmod +x deploy-all.sh
./deploy-all.sh
```

**这是最推荐的部署方式！**

### 9. .env.production.template

**内容：**

- 数据库配置
- JWT配置
- 微信小程序配置
- AI服务配置
- 服务器配置
- 详细的注释说明

**使用方法：**

```bash
# 复制到项目目录
cp .env.production.template ~/bracelet-fortune/apps/api/.env

# 编辑配置
nano ~/bracelet-fortune/apps/api/.env
```

**必须修改的配置：**

1. `JWT_SECRET` - 生成随机字符串
2. `WECHAT_APP_SECRET` - 填写小程序密钥
3. `OPENAI_API_KEY` - 填写AI密钥（可选）

### 10. upload-to-server.bat

**功能：**

- 自动上传deployment目录到服务器
- Windows批处理脚本

**使用方法：**

```
双击运行即可
```

**前提条件：**

- 已安装OpenSSH客户端（Windows 10/11自带）

### 11. upload-project.ps1

**功能：**

- 清理node_modules
- 清理编译产物
- 打包项目
- 上传到服务器

**使用方法：**

```powershell
# 右键 → 使用PowerShell运行
# 或在PowerShell中执行：
.\upload-project.ps1
```

---

## 🚀 推荐的部署流程

### 第1步：准备工作（5分钟）

1. 获取微信小程序密钥
2. 注册cpolar账号
3. 准备AI服务密钥（可选）

### 第2步：上传文件（2分钟）

**方案A：只上传部署脚本**

```
双击运行：upload-to-server.bat
```

**方案B：上传整个项目**

```powershell
右键运行：upload-project.ps1
```

### 第3步：连接服务器（1分钟）

```bash
ssh xiaoyi-dev1@47.239.179.9 -p 43122
# 密码：n6pCTKmpXDGVSjhfMzbX
```

### 第4步：运行部署（5分钟）

```bash
cd ~/deployment
chmod +x *.sh
./deploy-all.sh
```

按照提示操作即可！

### 第5步：配置小程序（5分钟）

1. 修改配置文件
2. 编译小程序
3. 配置微信公众平台
4. 上传体验版

---

## ✅ 部署成功的标志

- ✅ 后端服务运行正常（`pm2 status` 显示 online）
- ✅ cpolar服务运行正常（`sudo systemctl status cpolar` 显示 active）
- ✅ 可以通过cpolar地址访问API
- ✅ 小程序体验版可以正常使用
- ✅ 可以完成登录、绑定、查看运势等功能

---

## 📞 需要帮助？

### 查看日志

```bash
# 后端日志
pm2 logs bracelet-api

# cpolar日志
sudo journalctl -u cpolar -f
```

### 常见问题

查看：`README.md` 中的"常见问题"章节

---

## 🎉 总结

我为你准备了：

- ✅ 3个详细文档
- ✅ 5个自动化脚本
- ✅ 1个配置模板
- ✅ 2个本地工具

**你只需要：**

1. 提供必要信息（微信密钥、cpolar账号）
2. 运行脚本
3. 按照提示操作

**预计时间：** 15-20分钟完成部署

**祝你部署顺利！** 🚀
