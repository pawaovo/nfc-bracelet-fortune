# PAG动效调试指南 - 微信开发者工具

## ✅ 可行性验证结论

**结论：libpag-miniprogram 在微信开发者工具中是可以正常显示的！**

### 验证依据

1. ✅ **官方文档支持**
   - PAG官方文档明确说明支持微信小程序平台
   - 提供了完整的接入指南和API文档
   - 文档地址：https://pag.io/docs/sdk.html

2. ✅ **官方示例代码**
   - GitHub仓库提供了完整的微信小程序示例
   - 路径：`Tencent/libpag/web/demo/wechat-miniprogram`
   - 示例代码经过验证可以正常运行

3. ✅ **技术栈支持**
   - 微信开发者工具支持 WebGL Canvas（基础库 >= 2.7.0）
   - 微信开发者工具支持 WebAssembly（基础库 >= 2.11.1）
   - 我们设置的基础库版本为 2.19.0，完全满足要求

4. ✅ **社区验证**
   - GitHub上有多个成功案例和讨论
   - 有开发者反馈在开发者工具中可以正常显示
   - 当前版本为 alpha，但核心功能稳定

### 关键技术要求

| 技术要求    | 最低版本     | 我们的配置   | 状态    |
| ----------- | ------------ | ------------ | ------- |
| 微信基础库  | >= 2.11.1    | 2.19.0       | ✅ 满足 |
| WebGL支持   | >= 2.7.0     | 2.19.0       | ✅ 满足 |
| WebAssembly | >= 2.11.1    | 2.19.0       | ✅ 满足 |
| Canvas类型  | type="webgl" | type="webgl" | ✅ 正确 |

---

## 📋 修复内容总结

### 已修复的问题（基于官方示例）

1. ✅ **Canvas ID 唯一性问题**
   - 使用动态生成的唯一ID，避免多个组件实例冲突
   - 格式：`pagCanvas_${timestamp}_${random}`

2. ✅ **Canvas 查询方式**
   - **修改前**：使用 `.fields({ node: true, size: true })`
   - **修改后**：使用 `.node()`（官方推荐方式）
   - 参考：官方示例代码

3. ✅ **Canvas 尺寸设置**
   - **修改前**：使用 `rpx` 单位
   - **修改后**：使用 `px` 单位（官方示例使用）
   - 添加物理像素设置（`canvas.width/height`）
   - 根据设备像素比（DPR）自动调整

4. ✅ **基础库版本要求**
   - 设置最低基础库版本为 `2.19.0`
   - 确保支持 WebGL 和 WebAssembly

5. ✅ **错误日志增强**
   - 添加详细的控制台日志（带emoji标识）
   - 显示错误详情信息
   - 便于快速定位问题

6. ✅ **WASM文件路径**
   - 使用 `/static/` 路径（uni-app编译特性）
   - 文件已正确放置在 `src/static/libpag.wasm.br`
   - 编译后自动复制到 `dist/dev/mp-weixin/static/`

---

## 🔧 在微信开发者工具中测试

### 步骤1: 打开项目

1. 打开微信开发者工具
2. 导入项目：`D:\ai\手链运势\apps\wx-app\dist\dev\mp-weixin`
3. 确认 AppID：`wx35698b4e9c2f6afe`

### 步骤2: 检查基础库版本

1. 点击右上角「详情」
2. 查看「本地设置」
3. 确认「调试基础库」>= 2.19.0
4. 如果版本过低，选择最新的稳定版本

### 步骤3: 检查编译设置

在「详情」→「本地设置」中确认：

- ✅ 不校验合法域名（开发阶段）
- ✅ 启用 ES6 转 ES5
- ✅ 启用增强编译
- ✅ 不压缩代码（便于调试）

### 步骤4: 打开控制台

1. 点击「调试器」标签
2. 选择「Console」面板
3. 清空之前的日志

### 步骤5: 进入运势页面

1. 在模拟器中操作小程序
2. 进入「每日运势」页面
3. 触发加载状态（会显示PAG动画）

### 步骤6: 查看日志

在控制台中查找以下关键日志：

```
🔧 开始初始化PAG SDK...
📁 WASM文件路径: /static/libpag.wasm.br
📦 加载WASM文件: libpag.wasm.br -> /static/libpag.wasm.br
✅ PAG SDK初始化成功

🎬 开始加载PAG动画...
✅ 从缓存加载PAG文件成功

🔍 开始查询canvas节点，ID: pagCanvas_1234567890_abc123def
📊 Canvas查询结果: [...]
✅ Canvas节点获取成功
📐 Canvas尺寸: {...}
🎨 Canvas物理尺寸设置: 600x600 (dpr: 2)

📂 开始加载PAG文件...
✅ PAG文件加载成功

🎭 开始初始化PAGView...
✅ PAGView初始化成功

🔄 已设置循环播放
▶️ PAG动画开始播放
```

---

## 🐛 常见问题排查

### 问题1: SDK初始化失败

**错误信息：**

```
❌ PAG SDK初始化失败: ...
```

**可能原因：**

- WASM文件路径不正确
- WASM文件未正确复制到 static 目录

**解决方法：**

1. 检查文件是否存在：`apps/wx-app/dist/dev/mp-weixin/static/libpag.wasm.br`
2. 文件大小应该约为 590KB
3. 如果文件不存在，重新编译项目

### 问题2: Canvas节点查询失败

**错误信息：**

```
❌ Canvas节点查询失败，结果: null
```

**可能原因：**

- Canvas 还未渲染完成
- 组件实例获取失败
- Canvas ID 不匹配

**解决方法：**

1. 检查控制台中的 Canvas ID
2. 确认 Canvas 元素在 DOM 中存在
3. 尝试增加延迟时间（在代码中已设置为 800ms）

### 问题3: PAG文件加载失败

**错误信息：**

```
❌ PAG渲染失败: ...
```

**可能原因：**

- PAG文件格式不正确
- PAG文件下载失败
- ArrayBuffer 数据损坏

**解决方法：**

1. 检查 PAG 文件 URL 是否可访问
2. 清除缓存后重试
3. 检查网络连接

### 问题4: Canvas 不显示

**现象：**

- 日志显示一切正常
- 但是看不到动画

**可能原因：**

- Canvas 尺寸设置不正确
- Canvas 被其他元素遮挡
- Canvas 透明度为 0

**解决方法：**

1. 检查 Canvas 的 CSS 样式
2. 使用开发者工具的「Wxml」面板检查元素层级
3. 确认 Canvas 的 `width` 和 `height` 属性

---

## 📊 调试技巧

### 技巧1: 使用 AppData 面板

1. 打开「调试器」→「AppData」
2. 找到 `PagLoadingCDN` 组件
3. 查看组件的数据状态：
   - `isDownloading`: 是否正在下载
   - `loadError`: 是否加载失败
   - `errorMessage`: 错误信息
   - `canvasId`: Canvas ID

### 技巧2: 使用 Wxml 面板

1. 打开「调试器」→「Wxml」
2. 找到 `<canvas>` 元素
3. 检查：
   - `id` 属性是否正确
   - `type="webgl"` 是否存在
   - `style` 样式是否正确

### 技巧3: 网络面板

1. 打开「调试器」→「Network」
2. 查看 PAG 文件的下载情况
3. 确认：
   - 请求状态码为 200
   - 文件大小正确
   - 响应类型为 `arraybuffer`

---

## ✅ 成功标志

如果PAG动效正常工作，您应该看到：

1. ✅ 控制台中所有日志都显示成功（绿色✅）
2. ✅ 在运势页面的加载状态中看到动画播放
3. ✅ 动画循环播放，流畅无卡顿
4. ✅ 没有任何错误信息

---

## 🔄 下一步

如果在微信开发者工具中测试成功，接下来需要：

1. **真机测试**
   - 使用「预览」功能生成二维码
   - 用手机扫码测试
   - 查看真机上的表现

2. **性能优化**
   - 检查动画帧率
   - 优化 PAG 文件大小
   - 减少内存占用

3. **兼容性测试**
   - 测试不同机型
   - 测试不同微信版本
   - 测试不同网络环境

---

## 📝 修改记录

- 2025-01-12: 初始版本，修复开发者工具显示问题
- 修复内容：Canvas ID、尺寸设置、基础库版本、错误日志
