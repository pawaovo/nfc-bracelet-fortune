# NFC 手链小程序 H5 版本实施与待办清单

> 版本：v2.0（2025-11-13）  
> 面向角色：产品、前端、后端、测试、运维  
> 适用范围：在保持现有后端（47.239.179.9:43122）与数据库不变的前提下，将 uni-app 微信小程序复用为 H5 版本，实现 NFC 跳转网页、个人信息新增用户名/密码并绑定多个手环的能力。

---

## 1. 背景与目标

1. **保持现状**：后端服务、数据库、接口协议尽量不动，小程序照常运行。
2. **新增能力**：
   - 手机浏览器通过 NFC 跳转到 H5 页面；
   - H5 版与小程序共用 UI/流程，仅在个人信息页增加“用户名 + 密码”字段；
   - 同一账号允许绑定多个 NFC，绑定数据直接写入现有表结构。
3. **交付标准**：形成可运行的 H5 版本，完成自测、文档、NFC 现场验证；后续可在此基础上扩展账号体系和安全能力。

---

## 2. 范围与约束

| 项项       | 说明                                                                                 |
| ---------- | ------------------------------------------------------------------------------------ |
| **包含**   | H5 构建、前端页面适配、简单的用户名/密码采集与存储、绑定流程调整、NFC URL 规范。     |
| **不包含** | 账号加密/校验、完善登录体系、Web NFC 原生能力、全新 UI 页面、备案/正式上线。         |
| **环境**   | API 继续指向 `47.239.179.9:43122`；H5 部署域名可未备案，需支持 HTTPS（自签可接受）。 |
| **时间**   | 目标 1~2 周内完成基础版（见第 8 节里程碑）。                                         |

---

## 3. 总体实施路线

1. **准备阶段**
   - [ ] 创建分支 `feature/h5-simplified-login`；同步最新主干。
   - [ ] 补充 README / docs 中的 H5 描述与启动方式。
2. **实现阶段**
   - [ ] 前端：H5 构建、API 配置、页面适配、表单与状态管理。
   - [ ] 后端：Prisma 字段、DTO、Service 改造，保持与现有接口兼容。
   - [ ] 跨端联调：H5 与 API 对接，确保数据写入正确，旧小程序流程无回归。
3. **验证阶段**
   - [ ] H5 浏览器兼容性、自测与 QA；
   - [ ] NFC 标签写入与真机测试；
   - [ ] 部署 H5 静态资源至指定域名，完成可访问性验证。
4. **交付阶段**
   - [ ] 输出上线说明、操作手册、后续优化建议；
   - [ ] 若需继续开发（安全、账号体系），立项下一版本。

---

## 4. 任务拆解与 TODO

### 4.1 前端（负责人：前端团队）

| 模块      | TODO                                                                                                                                                                                                                           |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 构建/配置 | - [ ] 运行 `pnpm --filter wx-app dev:h5` 验证热更新；<br>- [ ] `src/api/config.ts` 增加 H5 专用 BASE_URL，确保默认指向 `http://47.239.179.9:43122`；<br>- [ ] 如需区分，多加一个 `ENV_PLATFORM` 标记，用于前端判断 H5/小程序。 |
| 状态管理  | - [ ] `src/stores/auth.ts` 新增 `username` 字段；<br>- [ ] 密码仅在提交动作中使用（避免长期缓存）；<br>- [ ] 更新 `initFromStorage` 逻辑，兼容 H5 的本地缓存。                                                                 |
| UI/交互   | - [ ] `pages/profile/index.vue` 加入“用户名 / 密码”输入框（沿用现有样式体系，保持 rpx/样式一致）；<br>- [ ] 校验：用户名、密码、生日必填；若缺失给出 toast；<br>- [ ] 若检测到 `nfcId`，在个人信息页展示绑定信息（可选）。     |
| API调用   | - [ ] 在 `src/api/auth.ts` 或 `profile.ts` 新增 `updateProfileWithCredentials` 方法，请求体包含 `username/password/birthday/nfcId`；<br>- [ ] 接口返回成功后更新 Pinia store 与本地缓存。                                      |
| NFC 流程  | - [ ] `pages/bind/index.vue` `onLoad` 使用 `options.nfcId` 或 `window.location.search` 解析；<br>- [ ] 将 `nfcId` 保存到 Pinia 或 `uni.setStorageSync`，供个人信息页复用；<br>- [ ] 若缺失 `nfcId`，提示用户重新贴 NFC。       |
| 适配      | - [ ] 检查全局样式、字体、静态资源路径在 H5 构建下是否可访问；<br>- [ ] 在 Chrome DevTools 设置多机型视图检查布局；<br>- [ ] 如需调整 `vite.config.ts` 的 `base` 或静态资源复制策略，记录在 README。                           |
| 调试文档  | - [ ] 在 `docs/h5-migration-plan.md` 或 README 中添加“前端启动步骤/H5 常见问题”；<br>- [ ] 输出调试截图/视频供评审。                                                                                                           |

### 4.2 后端（负责人：后端团队）

| 模块               | TODO                                                                                                                                                                                                                                                                                                                |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 数据库/类型        | - [ ] `prisma/schema.prisma` → `model User` 添加 `username String? @unique`、`password String?`；<br>- [ ] 运行 `pnpm --filter api prisma:migrate dev -n add-username-password`；<br>- [ ] 同步 `packages/shared-types/src/user.ts` 及相关 DTO。                                                                    |
| Service/Controller | - [ ] `users.service.ts`：新增 `findByUsername`、`setCredentials`；<br>- [ ] `profile.controller.ts` / `profile.service.ts` 接收 `username/password/nfcId` 并保存；<br>- [ ] `auth.service.ts` 的绑定逻辑中，若前端传来用户名/密码则写入用户表，允许一个用户绑定多条 `Bracelet`；<br>- [ ] 保持原有小程序流程不变。 |
| DTO/校验           | - [ ] 更新 `profile.dto.ts` 等文件，新增字段校验（`IsString`、`MinLength` 等）；<br>- [ ] 若用户名重复，返回业务错误码 `USERNAME_EXISTS`。                                                                                                                                                                          |
| CORS/配置          | - [ ] 复核 `main.ts` 的 `enableCors`，确保 H5 域名可访问；如需限制，可在 `.env` 增加 `ALLOWED_ORIGINS` 并解析。                                                                                                                                                                                                     |
| 文档/工具          | - [ ] 在 `docs/` 中新增接口字段说明（如 `docs/api-profile-web.md`）；<br>- [ ] 更新 Postman/Thunder 集合方便前端联调。                                                                                                                                                                                              |

### 4.3 部署与 NFC（负责人：运维/硬件）

| 模块      | TODO                                                                                                                                                                                                                                                                            |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| H5 部署   | - [ ] `pnpm --filter wx-app build:h5`，确认产物路径（通常为 `apps/wx-app/dist/build/h5`）；<br>- [ ] 部署至自有域名或服务器（如 Nginx 静态目录），配置 HTTPS（可自签证书）；<br>- [ ] 将 H5 域名写入文档，并在浏览器中验证可访问性、跨域情况。                                  |
| NFC 标签  | - [ ] 约定 URL 模板：`https://your-h5-domain.com/#/pages/bind/index?nfcId=<ID>`；<br>- [ ] 批量写入 NFC，记录 `nfcId` 与实体标签的对应列表；<br>- [ ] 真机测试：用手机浏览器贴卡 → 自动打开 H5 → 完成绑定；<br>- [ ] 若出现浏览器不支持、HTTPS 证书不可信等问题，记录处理方式。 |
| 域名/备案 | - [ ] 开发阶段允许未备案域名；<br>- [ ] 若后续需要对外服务，需在 `docs/deployment-checklist.md` 或本文件中追加备案流程（申请主体、资料、预计时间）。                                                                                                                            |

### 4.4 文档与交付（负责人：各角色协作）

- [ ] `docs/h5-migration-plan.md`（本文件）保持更新；
- [ ] README 增补 H5 启动/部署说明；
- [ ] 输出《NFC 标签写入指南》《H5 问题排查指南》（可另建文件）；
- [ ] PR 标题、描述、联调截图等完整，便于 Code Review。

---

## 5. 里程碑与时间预估

| 里程碑       | 具体内容                             | 负责人       | 预计耗时 |
| ------------ | ------------------------------------ | ------------ | -------- |
| M1：准备完成 | 分支就绪、环境可运行、任务分配明确   | 所有人       | 0.5 天   |
| M2：功能开发 | 前后端改造完成，可在本地联调         | 前端/后端    | 5~7 天   |
| M3：测试联调 | H5 自测 + QA、NFC 真机验证、问题修复 | 前端/QA/硬件 | 3~4 天   |
| M4：部署交付 | H5 静态资源上线、文档补齐、经验沉淀  | 运维/全员    | 1~2 天   |

> 合计约 8~13 天，可根据人力并行情况调整。

---

## 6. 测试计划

1. **功能测试**
   - H5 正常展示并走完绑定流程；
   - 表单必填校验、错误提示准确；
   - 数据库 `User` 表写入 `username/password/birthday`，`Bracelet` 表新增记录并关联正确。
2. **回归测试**
   - 小程序端各主要流程（登录、绑定、查看运势）无回归。
3. **跨端/兼容**
   - Safari（iOS）与 Chrome（Android）至少各 1 种机型验证；
   - 横竖屏、不同分辨率下 UI 无明显破坏。
4. **NFC 真机**
   - 使用实际 NFC 标签贴手机，验证 URL 自动打开、参数携带、后续流程；
   - 记录失败场景（如未开启 NFC、HTTPS 不可信）并给出提示方案。
5. **数据校验**
   - 同一用户绑定多个 NFC：数据库中同一 `userId` 对应多条 `Bracelet`；
   - 重新扫码相同 NFC，页面可识别已绑定状态（如需提示）。

---

## 7. 风险与缓解

| 风险                 | 影响               | 缓解措施                                                      |
| -------------------- | ------------------ | ------------------------------------------------------------- |
| H5 域名未备案        | 线上访问可能被拦截 | 开发阶段使用内网/海外服务器；正式上线前纳入备案计划           |
| 用户名/密码明文存储  | 安全隐患           | 文档注明“仅开发版”；后续版本补做加密 & 自建登录体系           |
| rpx/布局在 H5 不适配 | UI 错乱            | 提前在 DevTools 检查，必要时引入 `@media` 或 `vw` 单位        |
| NFC URL 被误改       | 无法获取 `nfcId`   | 将 URL 模板写入标签指南，并在前端检测 `nfcId` 缺失时提示      |
| 跨域/HTTPS 问题      | 浏览器请求失败     | 确认后端 CORS 已开放；H5 部署 HTTPS，必要时自签或配置反向代理 |

---

## 8. 下一步行动

1. 各角色确认本计划无遗漏，若有新增需求及时补充到文档。
2. 按照 TODO 列表认领任务（可在 issue/看板中拆分更细）。
3. 实施过程中，将进度和问题同步到该文档或任务看板，保持可追踪。
4. 完成本阶段后沉淀经验，评估是否启动“账号体系安全版”“Web NFC 版”等下一阶段。

---

如需对计划进行版本化升级，请在文件头部更新版本号，并记录变更摘要。\*\*\*
