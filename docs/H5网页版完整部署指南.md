# H5网页版完整部署指南

> **适用场景**: 将H5网页版部署到远程服务器(47.239.179.9)，使用1Panel面板管理，配置备案域名
> **当前日期**: 2025年1月
> **服务器**: 47.239.179.9:43122 (已有后端API和PostgreSQL数据库)

---

## 📋 目录

1. [部署前准备](#一部署前准备)
2. [数据库迁移](#二数据库迁移)
3. [后端API更新](#三后端api更新)
4. [H5前端构建](#四h5前端构建)
5. [1Panel部署静态网站](#五1panel部署静态网站)
6. [域名配置与备案](#六域名配置与备案)
7. [测试验证](#七测试验证)
8. [常见问题](#八常见问题)

---

## 一、部署前准备

### 1.1 服务器信息确认

```bash
服务器地址: 47.239.179.9
SSH端口: 43122
用户名: xiaoyi-dev1
密码: n6pCTKmpXDGVSjhfMzbX

# SSH连接命令
ssh xiaoyi-dev1@47.239.179.9 -p 43122
```

### 1.2 数据库信息确认

```bash
数据库名: bracelet-fortune
用户名: bracelet-fortune
密码: HvXFmwEwfntnScWZRJyB
容器名: 1Panel-postgresql-0i7g
内部端口: 5432
外部端口: 15432

# 内部连接字符串（推荐）
DATABASE_URL="postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@1Panel-postgresql-0i7g:5432/bracelet-fortune?schema=public"

# 外部连接字符串（备用）
DATABASE_URL="postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@47.239.179.9:15432/bracelet-fortune?schema=public"
```

### 1.3 域名信息

```bash
已备案域名: xiaoweigezzz.xyz (需要确认备案状态)
备案状态: 请在阿里云/腾讯云控制台查询
```

**⚠️ 重要**: 如果域名未备案，需要先完成ICP备案才能正式使用。备案期间可以使用IP地址访问。

### 1.4 所需工具

- **SSH工具**: Xshell、PuTTY 或 Windows Terminal
- **文件传输**: XFTP、WinSCP 或 scp命令
- **浏览器**: Chrome (用于访问1Panel面板)

---

## 二、数据库迁移

### 2.1 检查当前数据库Schema

H5网页版新增了 `username` 和 `password` 字段，需要确认数据库是否已更新。

**步骤1: 连接服务器**

```bash
ssh xiaoyi-dev1@47.239.179.9 -p 43122
# 输入密码: n6pCTKmpXDGVSjhfMzbX
```

**步骤2: 进入后端项目目录**

```bash
cd ~/bracelet-fortune/apps/api
```

**步骤3: 查看当前Schema**

```bash
# 查看schema.prisma文件
cat prisma/schema.prisma | grep -A 10 "model User"
```

**预期输出应包含**:

```prisma
model User {
  id            String   @id @default(uuid())
  wechatOpenId  String   @unique
  username      String?  @unique      # ← 这个字段
  password      String?                # ← 这个字段
  name          String?
  birthday      DateTime?
  ...
}
```

### 2.2 执行数据库迁移

**如果没有 `username` 和 `password` 字段，需要执行迁移**:

```bash
# 确保在 apps/api 目录下
cd ~/bracelet-fortune/apps/api

# 安装依赖（如果还没安装）
pnpm install

# 执行数据库迁移（生产环境）
pnpm prisma migrate deploy

# 或者开发环境迁移（会提示输入迁移名称）
pnpm prisma migrate dev --name add-username-password
```

**步骤4: 验证迁移结果**

```bash
# 生成Prisma客户端
pnpm prisma generate

# 查看数据库表结构
pnpm prisma studio
# 在浏览器中打开 http://47.239.179.9:5555 查看
# 按 Ctrl+C 退出
```

---

## 三、后端API更新

### 3.1 更新后端代码

**步骤1: 上传最新代码到服务器**

**方法A: 使用Git（推荐）**

```bash
# 在服务器上
cd ~/bracelet-fortune
git pull origin feature/h5-web
```

**方法B: 使用SCP上传**

```powershell
# 在本地Windows电脑上（PowerShell）
cd "D:\ai\手链运势"

# 压缩apps/api目录
Compress-Archive -Path apps\api\* -DestinationPath api-update.zip -Force

# 上传到服务器
scp -P 43122 api-update.zip xiaoyi-dev1@47.239.179.9:~/

# 在服务器上解压
ssh xiaoyi-dev1@47.239.179.9 -p 43122
cd ~/bracelet-fortune/apps/api
unzip -o ~/api-update.zip
```

### 3.2 重新构建并重启后端

```bash
# 进入后端目录
cd ~/bracelet-fortune/apps/api

# 安装依赖
pnpm install

# 构建后端
pnpm build

# 查看当前PM2进程
pm2 list

# 重启后端服务（假设进程名为 bracelet-api）
pm2 restart bracelet-api

# 查看日志确认启动成功
pm2 logs bracelet-api --lines 50
```

**预期日志输出**:

```
[Nest] INFO [NestFactory] Starting Nest application...
[Nest] INFO [InstanceLoader] AppModule dependencies initialized
[Nest] INFO [RoutesResolver] Mapped {/api/v1, GET} route
[Nest] INFO [NestApplication] Nest application successfully started
```

### 3.3 测试后端API

```bash
# 测试API是否正常
curl http://localhost:3000/api/v1

# 预期返回
# {"message":"NFC Bracelet Fortune API","version":"1.0.0"}

# 测试外部访问
curl http://47.239.179.9:43122/api/v1
```

---

## 四、H5前端构建

### 4.1 本地构建H5版本

**在本地Windows电脑上执行**:

```powershell
# 进入项目目录
cd "D:\ai\手链运势"

# 确保在正确的分支
git status
# 应该显示: On branch feature/h5-web

# 安装依赖（如果还没安装）
pnpm install

# 构建H5版本
cd apps\wx-app
pnpm build:h5
```

**构建完成后，产物位于**: `apps\wx-app\dist\build\h5\`

### 4.2 检查构建产物

```powershell
# 查看构建产物
dir apps\wx-app\dist\build\h5

# 应该包含以下文件/目录:
# - index.html
# - static/
# - assets/
# - manifest.json
```

### 4.3 本地预览（可选）

```powershell
# 使用serve预览
npx serve apps\wx-app\dist\build\h5

# 在浏览器访问: http://localhost:3000
# 测试URL: http://localhost:3000/#/pages/bind/index?nfcId=TEST
```

---

## 五、1Panel部署静态网站

### 5.1 访问1Panel面板

**步骤1: 在浏览器中打开1Panel**

```
访问地址: http://47.239.179.9:端口号
# 端口号通常是: 8090、8888、9999 等
# 如果不确定，可以在服务器上查询:
ssh xiaoyi-dev1@47.239.179.9 -p 43122
sudo 1pctl status
```

**步骤2: 登录1Panel**

- 输入管理员账号和密码
- 如果忘记密码，在服务器上执行: `sudo 1pctl user-info`

### 5.2 上传H5静态文件到服务器

**方法A: 使用XFTP/WinSCP（推荐）**

1. 打开XFTP或WinSCP
2. 连接到服务器:
   - 主机: 47.239.179.9
   - 端口: 43122
   - 用户名: xiaoyi-dev1
   - 密码: n6pCTKmpXDGVSjhfMzbX
3. 创建目标目录: `/home/xiaoyi-dev1/h5-web/`
4. 上传整个 `apps\wx-app\dist\build\h5\` 目录下的所有文件到 `/home/xiaoyi-dev1/h5-web/`

**方法B: 使用SCP命令**

```powershell
# 在本地Windows电脑上（PowerShell）
cd "D:\ai\手链运势\apps\wx-app\dist\build"

# 压缩h5目录
Compress-Archive -Path h5\* -DestinationPath h5-web.zip -Force

# 上传到服务器
scp -P 43122 h5-web.zip xiaoyi-dev1@47.239.179.9:~/

# 在服务器上解压
ssh xiaoyi-dev1@47.239.179.9 -p 43122
mkdir -p ~/h5-web
cd ~/h5-web
unzip -o ~/h5-web.zip
ls -la
# 应该看到: index.html, static/, assets/ 等文件
```

### 5.3 在1Panel中创建静态网站

**步骤1: 进入网站管理**

1. 登录1Panel面板
2. 点击左侧菜单 **「网站」**
3. 点击右上角 **「创建网站」** 按钮

**步骤2: 选择网站类型**

- 选择 **「静态网站」**
- 点击 **「下一步」**

**步骤3: 配置网站信息**

```
主域名: xiaoweigezzz.xyz
（如果域名未备案，可以先使用IP: 47.239.179.9）

网站别名（可选）: www.xiaoweigezzz.xyz

网站目录: /home/xiaoyi-dev1/h5-web
（选择刚才上传文件的目录）

默认文档: index.html

备注: NFC手链运势H5网页版
```

**步骤4: 高级设置（重要）**

```
✅ 开启HTTPS: 稍后配置（域名备案后）
✅ 开启Gzip压缩: 是
✅ 开启访问日志: 是
```

**步骤5: 点击「确定」创建网站**

### 5.4 配置网站伪静态（重要）

由于uni-app H5使用Hash路由，需要配置伪静态规则。

**步骤1: 进入网站设置**

1. 在网站列表中找到刚创建的网站
2. 点击 **「设置」** 按钮

**步骤2: 配置伪静态**

1. 点击左侧 **「伪静态」** 选项卡
2. 在配置框中输入以下规则:

```nginx
location / {
    try_files $uri $uri/ /index.html;
}

# 静态资源缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

3. 点击 **「保存」**

### 5.5 配置CORS（跨域）

如果H5网页需要访问后端API，需要配置CORS。

**步骤1: 在网站设置中找到「反向代理」**

1. 点击 **「反向代理」** 选项卡
2. 点击 **「添加」** 按钮

**步骤2: 配置API代理**

```
代理名称: api-proxy
代理路径: /api
目标地址: http://localhost:3000/api
```

**步骤3: 添加自定义配置**

在 **「自定义配置」** 中添加:

```nginx
# CORS配置
add_header Access-Control-Allow-Origin * always;
add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

# 处理OPTIONS预检请求
if ($request_method = 'OPTIONS') {
    return 204;
}
```

4. 点击 **「保存」**

**⚠️ 注意**: 如果后端API已经配置了CORS，这一步可以跳过。

### 5.6 测试网站访问

**步骤1: 使用IP访问**

```
浏览器访问: http://47.239.179.9
应该能看到H5网页的绑定页面
```

**步骤2: 测试NFC参数**

```
访问: http://47.239.179.9/#/pages/bind/index?nfcId=TEST
应该能正常加载并显示nfcId参数
```

**步骤3: 测试API连接**

1. 打开浏览器开发者工具（F12）
2. 切换到 **「Network」** 标签
3. 在H5页面中进行操作（如填写表单）
4. 查看是否有API请求发送到 `http://47.239.179.9:43122/api/v1/...`
5. 确认请求返回正常（状态码200）

---

## 六、域名配置与备案

### 6.1 检查域名备案状态

**步骤1: 查询备案信息**

访问工信部备案查询: https://beian.miit.gov.cn

输入域名: `xiaoweigezzz.xyz`

**步骤2: 确认备案状态**

- ✅ **已备案**: 可以直接使用，跳到 6.2
- ❌ **未备案**: 需要先完成备案，参考 6.3

### 6.2 配置已备案域名

**如果域名已备案，按以下步骤配置**:

**步骤1: 域名解析**

1. 登录域名服务商（阿里云/腾讯云/华为云）
2. 进入域名管理 → DNS解析
3. 添加A记录:

```
记录类型: A
主机记录: @
记录值: 47.239.179.9
TTL: 600

记录类型: A
主机记录: www
记录值: 47.239.179.9
TTL: 600
```

4. 保存配置，等待DNS生效（通常5-10分钟）

**步骤2: 在1Panel中绑定域名**

1. 进入网站设置
2. 点击 **「域名」** 选项卡
3. 修改主域名为: `xiaoweigezzz.xyz`
4. 添加别名: `www.xiaoweigezzz.xyz`
5. 保存

**步骤3: 配置SSL证书（HTTPS）**

1. 在网站设置中点击 **「HTTPS」** 选项卡
2. 选择 **「Let's Encrypt」** 免费证书
3. 填写邮箱地址
4. 点击 **「申请证书」**
5. 等待证书申请成功（通常1-2分钟）
6. 开启 **「强制HTTPS」**（HTTP自动跳转到HTTPS）

**步骤4: 测试域名访问**

```
浏览器访问: https://xiaoweigezzz.xyz
应该能正常访问H5网页，并显示安全锁图标
```

### 6.3 域名未备案的处理方案

**如果域名未备案，有以下选择**:

**方案A: 完成ICP备案（推荐）**

1. 参考文档: `docs/icp-filing-guide.md`
2. 备案时间: 7-20个工作日
3. 备案期间可以使用IP地址访问

**方案B: 使用临时域名（测试用）**

1. 使用cpolar内网穿透（免费版每天变化）
2. 参考之前的小程序部署方案
3. 仅用于测试，不能正式使用

**方案C: 购买已备案域名**

1. 在域名交易平台购买已备案的.com或.cn域名
2. 价格通常比新域名贵
3. 可以立即使用

---

## 七、测试验证

### 7.1 功能测试清单

**基础功能测试**:

- [ ] 访问首页（绑定页面）正常显示
- [ ] URL参数 `?nfcId=TEST` 能正确传递
- [ ] 页面样式、图片正常加载
- [ ] 点击按钮跳转到个人信息页面

**表单提交测试**:

- [ ] 填写用户名、密码、生日
- [ ] 点击提交按钮
- [ ] 检查Network中API请求是否发送
- [ ] 确认数据成功保存到数据库

**完整流程测试**:

1. 访问绑定页面: `https://xiaoweigezzz.xyz/#/pages/bind/index?nfcId=TEST001`
2. 点击"绑定我的手链"
3. 填写个人信息（用户名、密码、生日）
4. 提交表单
5. 跳转到AI生成页面
6. 等待运势生成
7. 查看运势详情页面
8. 测试历史记录功能

### 7.2 性能测试

**步骤1: 测试页面加载速度**

```bash
# 在服务器上测试
curl -w "@-" -o /dev/null -s https://xiaoweigezzz.xyz <<'EOF'
    time_namelookup:  %{time_namelookup}\n
       time_connect:  %{time_connect}\n
    time_appconnect:  %{time_appconnect}\n
      time_redirect:  %{time_redirect}\n
   time_pretransfer:  %{time_pretransfer}\n
 time_starttransfer:  %{time_starttransfer}\n
                    ----------\n
         time_total:  %{time_total}\n
EOF
```

**步骤2: 检查资源加载**

1. 打开浏览器开发者工具（F12）
2. 切换到 **「Network」** 标签
3. 刷新页面
4. 查看各资源加载时间
5. 确认没有404错误

### 7.3 数据库验证

**步骤1: 连接数据库**

```bash
# 在服务器上
ssh xiaoyi-dev1@47.239.179.9 -p 43122

# 使用Prisma Studio查看数据
cd ~/bracelet-fortune/apps/api
pnpm prisma studio
```

**步骤2: 检查数据**

1. 在浏览器中打开 `http://47.239.179.9:5555`
2. 点击 **「User」** 表
3. 查看是否有新增的用户记录
4. 确认 `username` 和 `password` 字段有值
5. 确认 `nfcId` 绑定关系正确

### 7.4 NFC真机测试（可选）

**如果有NFC标签，可以进行真机测试**:

**步骤1: 写入NFC标签**

使用NFC写卡器或手机NFC工具，写入URL:

```
https://xiaoweigezzz.xyz/#/pages/bind/index?nfcId=NFC001
```

**步骤2: 手机NFC测试**

1. 打开手机NFC功能
2. 将手机靠近NFC标签
3. 手机应自动打开浏览器并访问H5页面
4. 测试完整的绑定流程

---

## 八、常见问题

### 8.1 网站无法访问

**问题**: 访问域名或IP时显示"无法访问此网站"

**解决方案**:

1. **检查1Panel网站状态**

   ```bash
   # 在服务器上
   sudo 1pctl status
   # 确认1Panel服务运行正常
   ```

2. **检查OpenResty状态**

   ```bash
   # 查看OpenResty进程
   ps aux | grep openresty

   # 重启OpenResty
   sudo systemctl restart openresty
   ```

3. **检查防火墙**

   ```bash
   # 查看防火墙状态
   sudo ufw status

   # 开放80和443端口
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   ```

4. **检查端口占用**
   ```bash
   # 查看80端口是否被占用
   sudo netstat -tlnp | grep :80
   ```

### 8.2 页面显示404

**问题**: 访问网站显示404 Not Found

**解决方案**:

1. **检查网站目录**

   ```bash
   # 确认文件存在
   ls -la /home/xiaoyi-dev1/h5-web/
   # 应该看到 index.html
   ```

2. **检查文件权限**

   ```bash
   # 修改文件权限
   sudo chmod -R 755 /home/xiaoyi-dev1/h5-web/
   sudo chown -R xiaoyi-dev1:xiaoyi-dev1 /home/xiaoyi-dev1/h5-web/
   ```

3. **检查伪静态配置**
   - 在1Panel中进入网站设置
   - 检查伪静态规则是否正确配置
   - 确认有 `try_files $uri $uri/ /index.html;`

### 8.3 API请求失败

**问题**: 浏览器控制台显示API请求失败（CORS错误或网络错误）

**解决方案**:

1. **检查后端API状态**

   ```bash
   # 查看PM2进程
   pm2 list

   # 查看后端日志
   pm2 logs bracelet-api --lines 50

   # 测试API
   curl http://localhost:3000/api/v1
   ```

2. **检查CORS配置**

   在后端 `apps/api/src/main.ts` 中确认CORS配置:

   ```typescript
   app.enableCors({
     origin: '*', // 或指定域名
     credentials: true,
   });
   ```

3. **检查API地址配置**

   在H5前端 `apps/wx-app/src/api/config.ts` 中确认:

   ```typescript
   // 确保使用正确的API地址
   PROD_BASE_URL: 'http://47.239.179.9:43122';
   // 或
   PROD_BASE_URL: 'https://xiaoweigezzz.xyz';
   ```

4. **重新构建前端**
   ```powershell
   # 在本地
   cd "D:\ai\手链运势\apps\wx-app"
   pnpm build:h5
   # 重新上传到服务器
   ```

### 8.4 SSL证书申请失败

**问题**: Let's Encrypt证书申请失败

**解决方案**:

1. **检查域名解析**

   ```bash
   # 测试域名解析
   ping xiaoweigezzz.xyz
   # 应该解析到 47.239.179.9
   ```

2. **检查80端口**

   ```bash
   # 确保80端口开放（Let's Encrypt需要）
   sudo netstat -tlnp | grep :80
   ```

3. **手动申请证书**

   ```bash
   # 使用certbot手动申请
   sudo certbot certonly --webroot \
     -w /home/xiaoyi-dev1/h5-web \
     -d xiaoweigezzz.xyz \
     -d www.xiaoweigezzz.xyz
   ```

4. **检查域名备案**
   - 确认域名已完成ICP备案
   - 未备案域名无法申请SSL证书

### 8.5 数据库连接失败

**问题**: 后端日志显示数据库连接错误

**解决方案**:

1. **检查数据库容器状态**

   ```bash
   # 查看PostgreSQL容器
   docker ps | grep postgresql

   # 查看容器日志
   docker logs 1Panel-postgresql-0i7g
   ```

2. **测试数据库连接**

   ```bash
   # 使用psql测试
   psql "postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@1Panel-postgresql-0i7g:5432/bracelet-fortune"

   # 或使用外部地址
   psql "postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@47.239.179.9:15432/bracelet-fortune"
   ```

3. **检查环境变量**

   ```bash
   # 查看后端.env文件
   cat ~/bracelet-fortune/apps/api/.env | grep DATABASE_URL
   ```

4. **重启数据库容器**
   ```bash
   # 在1Panel中重启PostgreSQL容器
   # 或使用docker命令
   docker restart 1Panel-postgresql-0i7g
   ```

### 8.6 页面样式错乱

**问题**: H5页面显示但样式不正常

**解决方案**:

1. **检查静态资源路径**
   - 打开浏览器开发者工具（F12）
   - 查看Console是否有资源加载错误
   - 检查Network中CSS/JS文件是否404

2. **检查base路径配置**

   在 `apps/wx-app/manifest.json` 中检查:

   ```json
   {
     "h5": {
       "router": {
         "mode": "hash",
         "base": "/"
       }
     }
   }
   ```

3. **清除浏览器缓存**
   - 按 Ctrl+Shift+Delete
   - 清除缓存和Cookie
   - 刷新页面（Ctrl+F5）

4. **重新构建**

   ```powershell
   # 删除旧的构建产物
   Remove-Item -Recurse -Force apps\wx-app\dist

   # 重新构建
   cd apps\wx-app
   pnpm build:h5
   ```

---

## 九、部署检查清单

### 9.1 部署前检查

- [ ] 服务器SSH连接正常
- [ ] 1Panel面板可以访问
- [ ] 数据库运行正常
- [ ] 后端API运行正常
- [ ] 域名已备案（或准备使用IP访问）

### 9.2 数据库检查

- [ ] 已执行Prisma迁移
- [ ] `users` 表包含 `username` 和 `password` 字段
- [ ] 数据库连接字符串正确
- [ ] 可以通过Prisma Studio查看数据

### 9.3 后端检查

- [ ] 后端代码已更新到最新版本
- [ ] 依赖已安装（pnpm install）
- [ ] 代码已构建（pnpm build）
- [ ] PM2进程运行正常
- [ ] API接口可以访问

### 9.4 前端检查

- [ ] H5代码已构建（pnpm build:h5）
- [ ] 构建产物已上传到服务器
- [ ] 文件权限正确（755）
- [ ] 在1Panel中创建了静态网站
- [ ] 伪静态规则已配置

### 9.5 域名检查

- [ ] 域名DNS解析正确
- [ ] 域名已绑定到1Panel网站
- [ ] SSL证书已申请（如果使用HTTPS）
- [ ] 强制HTTPS已开启（可选）

### 9.6 功能检查

- [ ] 网站可以正常访问
- [ ] NFC参数可以正确传递
- [ ] 表单可以提交
- [ ] API请求正常
- [ ] 数据可以保存到数据库
- [ ] 完整流程测试通过

---

## 十、后续优化建议

### 10.1 性能优化

1. **开启Gzip压缩**
   - 在1Panel网站设置中开启
   - 可以减少50-70%的传输大小

2. **配置CDN加速**
   - 使用阿里云CDN或腾讯云CDN
   - 加速静态资源加载

3. **开启浏览器缓存**
   - 在Nginx配置中添加缓存头
   - 减少重复请求

### 10.2 安全加固

1. **配置WAF（Web应用防火墙）**
   - 1Panel内置WAF功能
   - 防止SQL注入、XSS攻击

2. **限制访问频率**
   - 配置IP访问限制
   - 防止恶意刷量

3. **定期备份**
   - 设置数据库自动备份
   - 备份网站文件

### 10.3 监控告警

1. **配置监控**
   - 使用1Panel的监控功能
   - 监控CPU、内存、磁盘使用率

2. **日志分析**
   - 定期查看访问日志
   - 分析用户行为

3. **告警通知**
   - 配置邮件或短信告警
   - 及时发现问题

---

## 十一、联系支持

### 11.1 1Panel官方支持

- 官网: https://1panel.cn
- 文档: https://1panel.cn/docs
- 社区: https://bbs.fit2cloud.com

### 11.2 技术支持

如果遇到无法解决的问题，可以:

1. 查看1Panel日志: `sudo 1pctl logs`
2. 查看OpenResty日志: `/opt/1panel/apps/openresty/openresty/logs/`
3. 查看后端日志: `pm2 logs bracelet-api`
4. 查看数据库日志: `docker logs 1Panel-postgresql-0i7g`

---

## 附录A: 快速命令参考

### 服务器连接

```bash
# SSH连接
ssh xiaoyi-dev1@47.239.179.9 -p 43122

# 文件上传
scp -P 43122 文件名 xiaoyi-dev1@47.239.179.9:~/
```

### 1Panel管理

```bash
# 查看1Panel状态
sudo 1pctl status

# 重启1Panel
sudo 1pctl restart

# 查看1Panel日志
sudo 1pctl logs

# 查看用户信息
sudo 1pctl user-info
```

### 后端管理

```bash
# 查看PM2进程
pm2 list

# 重启后端
pm2 restart bracelet-api

# 查看日志
pm2 logs bracelet-api

# 停止后端
pm2 stop bracelet-api

# 启动后端
pm2 start bracelet-api
```

### 数据库管理

```bash
# 连接数据库
psql "postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@1Panel-postgresql-0i7g:5432/bracelet-fortune"

# 查看数据库容器
docker ps | grep postgresql

# 查看容器日志
docker logs 1Panel-postgresql-0i7g

# 重启容器
docker restart 1Panel-postgresql-0i7g
```

### Nginx管理

```bash
# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 查看Nginx状态
sudo systemctl status nginx

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

---

## 附录B: 环境变量配置参考

### 后端 .env 文件

```env
# 数据库配置
DATABASE_URL="postgresql://bracelet-fortune:HvXFmwEwfntnScWZRJyB@1Panel-postgresql-0i7g:5432/bracelet-fortune?schema=public"

# JWT配置
JWT_SECRET="ba75f472156ee4cf8065bd4e4024064b6b9c8b8dc07f44bc26c80cee341dde0145c233330e3c9ec0ab92ad0ac4054f95ae6ebfe37fc813afb0ed1bfa99c"
JWT_EXPIRES_IN="7d"

# 微信小程序配置
WECHAT_APP_ID="wx7ba4129d919fdf01"
WECHAT_APP_SECRET="你的AppSecret"
WECHAT_DEV_MODE="false"

# AI服务配置
OPENAI_API_KEY="732372aa-8401-4d91-b9c2-47726252d6ee"
OPENAI_BASE_URL="https://ark.cn-beijing.volces.com/api/v3"
OPENAI_MODEL="doubao-seed-1-6-lite-251015"

# 服务器配置
PORT=3000
NODE_ENV="production"
LOG_LEVEL="info"

# PAG静态文件路径
PAG_STATIC_PATH="/home/xiaoyi-dev1/static/pag"
```

### 前端 API 配置

在 `apps/wx-app/src/api/config.ts`:

```typescript
export const API_CONFIG = {
  // 开发环境
  DEV_BASE_URL: 'http://localhost:3000',

  // 生产环境（使用域名）
  PROD_BASE_URL: 'https://xiaoweigezzz.xyz',

  // 或使用IP（域名未备案时）
  // PROD_BASE_URL: 'http://47.239.179.9:43122',

  TIMEOUT: 30000,
  VERSION: 'v1',
};
```

---

**部署完成！** 🎉

如有问题，请参考常见问题章节或查看相关日志。
