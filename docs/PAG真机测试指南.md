# PAG 动效真机测试指南

> **最后更新：** 2025-01-12
> **状态：** ✅ 已验证可用
> **适用场景：** cpolar 内网穿透 + PAG 动效加载

## 📋 测试前准备

### 1. 确认当前状态

在进行真机测试前，请确认：

- ✅ 后端服务已部署并正常运行（本地或服务器）
- ✅ cpolar 内网穿透已配置（或已有 HTTPS 域名）
- ✅ 数据库已配置并可访问
- ✅ 微信公众平台域名已配置
- ✅ 小程序代码已编译为生产版本

### 2. PAG 动效配置说明

**当前 PAG 配置：**

- **总时长：** 25 秒
- **循环段：** 13s-18s（等待 AI 生成时循环播放）
- **结束动画：** 20s-25s（AI 返回后播放）
- **文件大小：** 6.49 MB
- **CDN 地址：** `https://ghproxy.com/...`（国内镜像）
- **下载超时：** 120 秒

---

## 🔧 部署前的代码检查

### 检查1: API 配置（cpolar 方案）

**文件：** `apps/wx-app/src/api/config.ts`

#### 获取 cpolar 地址

**方法1：访问 cpolar 控制台**

```bash
http://127.0.0.1:4040
```

**方法2：查看配置文件**

```typescript
// apps/wx-app/src/api/config.ts 第13行
TUNNEL_BASE_URL: 'https://41412356.cpolar.io',  // 你的实际地址
```

#### 确认配置正确

```typescript
export const API_CONFIG = {
  // 内网穿透地址（当前使用）
  TUNNEL_BASE_URL: 'https://41412356.cpolar.io', // ⚠️ 确认是你的地址
  // 请求超时时间（120秒，AI生成需要较长时间）
  TIMEOUT: 120000, // ⚠️ 已更新为120秒
  VERSION: 'v1',
};

// 当前环境配置
const CURRENT_ENV: EnvType = 'tunnel'; // ⚠️ 确认为 'tunnel'
```

⚠️ **cpolar 注意事项：**

- 免费版地址会变化（每次重启）
- 地址变化后需要重新配置微信公众平台
- 建议购买付费版（10元/月）获得固定域名

### 检查2: PAG 文件配置

**文件：** `apps/wx-app/src/utils/pagPreloader.ts`

```typescript
// 使用国内镜像CDN（已优化）
const PAG_FILE_URL =
  'https://ghproxy.com/https://raw.githubusercontent.com/pawaovo/pag-files/main/loading_bmp.pag';
const DOWNLOAD_TIMEOUT = 120000; // 120秒超时
```

**文件：** `apps/wx-app/src/components/PagLoadingCDN.vue`

```typescript
// WASM 文件路径（已配置）
PAG = await PAGInit({
  locateFile: (file: string) => '/static/' + file,
});
```

### 检查3: PAG 动画配置

**文件：** `apps/wx-app/src/pages/fortune/index.vue`

```typescript
const PAG_CONFIG = {
  totalDuration: 25, // 总时长 25秒
  loopStart: 13, // 循环开始 13秒 (52%)
  loopEnd: 18, // 循环结束 18秒 (72%)
  endingStart: 20, // 结束动画 20秒 (80%)
  endingBufferMs: 500, // 结束缓冲 500ms
  componentCheckIntervalMs: 100, // 组件检查间隔
  componentInitDelayMs: 300, // 组件初始化延迟
};
```

---

## 📦 编译生产版本

### 步骤1: 清理旧的编译文件

```bash
# 在本地电脑执行
cd D:\ai\手链运势\apps\wx-app

# 删除旧的编译文件
Remove-Item -Recurse -Force dist\build\mp-weixin -ErrorAction SilentlyContinue
```

### 步骤2: 编译生产版本

```bash
# 编译生产版本
pnpm build:mp-weixin
```

### 步骤3: 验证编译结果

检查以下文件是否存在：

```
✅ dist/build/mp-weixin/app.js
✅ dist/build/mp-weixin/app.json
✅ dist/build/mp-weixin/static/libpag.wasm.br
✅ dist/build/mp-weixin/components/PagLoadingCDN.js
✅ dist/build/mp-weixin/pages/fortune/index.js
```

---

## 🌐 微信公众平台配置

### 配置服务器域名

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入：**开发 → 开发管理 → 开发设置**
3. 找到「服务器域名」，点击「修改」

#### request 合法域名

添加以下域名：

```
https://41412356.cpolar.io              # 你的cpolar地址（⚠️ 替换为实际地址）
https://ark.cn-beijing.volces.com       # 火山引擎AI服务
https://ghproxy.com                     # PAG文件CDN镜像
```

#### downloadFile 合法域名

添加以下域名：

```
https://ghproxy.com                     # PAG文件下载
```

⚠️ **重要提示：**

- 每月只能修改 5 次，请确认地址正确
- cpolar 免费版地址会变化，需要重新配置
- 建议购买 cpolar 付费版（10元/月）获得固定域名

### 配置基础库版本

1. 进入：**开发 → 开发管理 → 版本管理**
2. 找到「基础库最低版本设置」
3. 设置为：`2.19.0` 或更高

---

## 📱 上传体验版

### 步骤1: 打开微信开发者工具

1. 打开微信开发者工具
2. 导入项目：`D:\ai\手链运势\apps\wx-app\dist\build\mp-weixin`
3. 确认AppID：`wx35698b4e9c2f6afe`

### 步骤2: 检查编译设置

在「详情」→「本地设置」中：

- ✅ **不校验合法域名** - 关闭（真机测试必须开启校验）
- ✅ **ES6 转 ES5** - 开启
- ✅ **增强编译** - 开启
- ✅ **上传代码时样式自动补全** - 开启
- ✅ **上传代码时自动压缩** - 开启

### 步骤3: 设置基础库版本

在「详情」→「本地设置」中：

- **调试基础库**：选择 `2.19.0` 或更高版本

### 步骤4: 上传代码

1. 点击工具栏的「上传」按钮
2. 填写版本信息：
   - **版本号**：`1.0.0`
   - **项目备注**：`PAG动效真机测试版本`
3. 点击「上传」

### 步骤5: 生成体验版二维码

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入：**管理 → 版本管理**
3. 在「开发版本」中找到刚上传的版本
4. 点击「选为体验版」
5. 点击「体验版二维码」下载或扫码

---

## 🧪 真机测试步骤

### 测试环境要求

| 项目            | 要求                         |
| --------------- | ---------------------------- |
| **微信版本**    | >= 7.0.17（支持WebAssembly） |
| **iOS系统**     | >= 11.3（支持WebGL）         |
| **Android系统** | >= 7.0（支持WebGL）          |
| **基础库版本**  | >= 2.19.0                    |

### 测试步骤

#### 1. 扫码进入体验版

- 使用微信扫描体验版二维码
- 确认是「体验版」标识

#### 2. 开启调试模式

- 在小程序右上角点击「...」
- 选择「打开调试」
- 这样可以在微信内查看控制台日志

#### 3. 测试PAG动效显示

1. **进入运势页面**
   - 点击「每日运势」
   - 触发AI生成流程

2. **观察PAG动效**
   - ✅ 是否显示PAG加载动画
   - ✅ 动画是否流畅播放
   - ✅ 动画是否循环播放
   - ✅ 是否有卡顿或闪烁

3. **检查错误信息**
   - 如果动画不显示，查看是否有错误提示
   - 记录错误信息的具体内容

#### 4. 查看控制台日志

在微信中打开调试模式后，可以看到以下关键日志：

**成功的日志示例：**

```
运势页面加载 {fromProfile: "true"}
调用API获取今日运势
🎬 开始加载PAG动画...
🔧 初始化PAG SDK (WASM: /static/libpag.wasm.br)
✅ PAG SDK初始化成功
✅ 从缓存加载成功 ( 6.49 MB)
✅ PAG 组件已就绪
📊 PAG 文件信息: {duration: 25, frameRate: 24, ...}
🎬 启动 PAG 加载动画
📐 循环区间: 52% - 72%
🎬 播放初始动画: 0% -> 52%
🔄 开始循环中间段: 52% - 72%, 帧率: 24fps
⏸️ 初始动画播放完成，停在 52%
成功获取今日运势
✅ AI 返回结果，播放结束动画
📐 结束动画起点: 80%
⏱️ 结束动画时长: 5.0秒
🎬 播放结束动画，从进度 80% 开始
✅ 结束动画播放完成
```

---

## 🐛 常见问题排查

### 问题1: PAG 动效不显示

**检查清单：**

- [ ] **WASM 文件加载**

  ```bash
  # 检查文件是否存在
  ls apps/wx-app/dist/build/mp-weixin/static/libpag.wasm.br
  # 应显示约 590KB
  ```

- [ ] **PAG 文件下载**
  - 查看日志是否有 `✅ 从缓存加载成功`
  - 检查 CDN 地址是否可访问
  - 检查域名是否在合法域名列表中

- [ ] **组件就绪状态**
  - 查看日志是否有 `✅ PAG 组件已就绪`
  - 如果一直显示 `⏳ 等待 PAG 组件加载完成...`，说明组件初始化失败

- [ ] **网络连接**
  - 检查手机网络是否正常
  - 尝试切换 WiFi/4G 网络
  - 检查 cpolar 是否正在运行

**解决方法：**

1. **清除缓存重试**
   - 微信开发者工具：工具栏 → 清缓存
   - 真机：删除小程序重新进入

2. **检查域名配置**
   - 确认 `https://ghproxy.com` 已添加到合法域名
   - 确认 cpolar 地址已添加到合法域名

3. **查看详细日志**
   - 开启调试模式查看完整错误信息

### 问题2: AI 生成超时

**错误信息：**

```
request:fail fail:time out
[NetworkTask] reportTask costTime too long: 60029ms
```

**原因：** AI 生成时间超过请求超时时间

**解决方法：**

已优化超时配置：

- 前端请求超时：120 秒
- 后端 AI Service 超时：100 秒
- 后端 Fortune Service 超时：110 秒

如果仍然超时，会显示重试界面，用户可以手动重试（最多 3 次）。

### 问题3: 动画播放不完整

**现象：** AI 返回后直接跳转，结束动画没有播放

**原因：** 结束动画播放逻辑问题

**解决方法：**

已修复：`playPagEnding()` 现在返回 Promise，等待结束动画播放完成（5秒）后才跳转。

### 问题4: 进入页面延迟 1-2 秒才开始播放

**原因：** PAG 组件初始化需要时间

**解决方法：**

已优化：

- 添加 `isReady` 标记跟踪组件就绪状态
- 使用 100ms 间隔检查组件是否就绪
- 组件就绪后立即开始播放

---

## 📊 测试记录表

请在测试时填写以下表格：

| 测试项      | 测试设备  | 系统版本   | 微信版本 | 测试结果 | 备注   |
| ----------- | --------- | ---------- | -------- | -------- | ------ |
| PAG动效显示 | iPhone 13 | iOS 16.0   | 8.0.30   | ✅ 通过  | 流畅   |
| PAG动效显示 | 小米12    | Android 12 | 8.0.30   | ❌ 失败  | 不显示 |
| 动画流畅度  |           |            |          |          |        |
| 内存占用    |           |            |          |          |        |
| 加载速度    |           |            |          |          |        |

---

## 📊 快速检查清单

### 部署前检查

- [ ] cpolar 正在运行（访问 `http://127.0.0.1:4040` 确认）
- [ ] 后端服务正在运行（访问 `http://localhost:3000/api/v1` 确认）
- [ ] 获取了 cpolar 地址
- [ ] 更新了 `apps/wx-app/src/api/config.ts` 配置
- [ ] 配置了微信公众平台域名
- [ ] 编译了小程序（`pnpm build:mp-weixin`）
- [ ] 上传了体验版

### 真机测试检查

- [ ] 扫码进入体验版
- [ ] 开启了调试模式
- [ ] 测试了 PAG 动效
- [ ] 查看了控制台日志
- [ ] 记录了测试结果

### 预期效果

- [ ] 进入页面后立即播放动画（不再有 1-2 秒延迟）
- [ ] AI 生成时循环播放 13s-18s 的动画
- [ ] AI 返回后播放 20s-25s 的结束动画（5秒）
- [ ] 结束动画播放完成后才显示运势结果
- [ ] 无 WASM 内存错误
- [ ] 无超时错误（或超时后显示重试界面）

---

## ✅ 测试通过标准

PAG 动效真机测试通过的标准：

1. ✅ **功能正常**
   - PAG 动画正常显示
   - 动画流畅播放，无卡顿
   - 循环播放正确（13s-18s）
   - 结束动画正确（20s-25s）

2. ✅ **性能达标**
   - 首次加载时间 < 3 秒
   - 动画帧率 >= 24fps
   - 内存占用 < 50MB

3. ✅ **稳定性达标**
   - 连续播放 10 次无崩溃
   - 切换页面后返回正常
   - 网络波动不影响已缓存的动画

4. ✅ **错误处理正常**
   - AI 超时显示重试界面
   - 重试功能正常工作
   - 达到重试上限后自动降级

---

## 📝 已知问题和解决方案

### 已解决的问题

1. ✅ **PAG 文件下载超时**
   - 解决方案：使用国内镜像 CDN（ghproxy.com）
   - 解决方案：增加下载超时时间到 120 秒

2. ✅ **AI 生成超时**
   - 解决方案：增加请求超时时间到 120 秒
   - 解决方案：超时后显示重试界面

3. ✅ **进入页面延迟 1-2 秒**
   - 解决方案：添加组件就绪状态检查
   - 解决方案：优化组件初始化流程

4. ✅ **结束动画未播放完就跳转**
   - 解决方案：等待结束动画播放完成（5秒）

5. ✅ **WASM 内存错误**
   - 解决方案：添加组件就绪标记
   - 解决方案：优化资源清理逻辑

---

## 🎉 总结

**当前状态：** ✅ 已完成优化，可以进行真机测试

**主要改进：**

1. 优化了 PAG 动画循环控制（13s-18s 循环，20s-25s 结束）
2. 增加了超时时间配置（120 秒）
3. 优化了组件初始化流程（立即播放）
4. 完善了错误处理（超时重试）
5. 修复了结束动画播放问题

**下一步：**

1. 重新构建小程序：`pnpm build:mp-weixin`
2. 上传体验版测试
3. 真机测试验证
4. 收集用户反馈

---

**祝测试顺利！** 🚀
