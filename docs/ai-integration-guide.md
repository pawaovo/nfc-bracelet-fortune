# AI运势生成集成指南

## 🎯 功能概述

本项目已成功集成AI运势生成功能，支持智能运势分析和优雅降级机制。

### 核心特性

- ✅ **AI优先生成**：优先使用AI模型生成个性化运势
- ✅ **智能重试机制**：AI失败时支持用户手动重试（最多3次）
- ✅ **优雅降级**：最终降级到固定模板，确保用户体验
- ✅ **场景区分**：根据用户认证状态智能选择生成策略
- ✅ **性能优化**：40秒AI超时 + 数据库缓存机制

## 🔧 配置要求

### 环境变量配置

在 `apps/api/.env` 文件中添加以下配置：

```env
# AI配置（必需）
OPENAI_API_KEY=your-api-key-here
OPENAI_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
OPENAI_MODEL=doubao-seed-1-6-lite-251015

# AI功能开关（可选）
AI_ENABLED=true
AI_TIMEOUT_MS=40000
AI_MAX_RETRIES=3
```

### 支持的AI服务

- **火山引擎 Doubao**（当前使用）
- **DeepSeek API**
- **OpenAI API**
- **其他OpenAI兼容API**

## 🎮 用户体验流程

### 场景1：AI生成成功

```
用户请求运势 → 检查缓存 → AI生成(40s内) → 显示结果 → 保存缓存
```

### 场景2：AI生成失败

```
用户请求运势 → AI失败 → 显示重试界面 → 用户选择重试/降级
```

### 场景3：重试流程

```
用户点击重试 → AI重新生成 → 成功/失败 → 最多重试3次 → 自动降级
```

## 📱 前端界面说明

### 加载状态

- 显示动态加载文案："正在分析您的星象运势..."
- 文案每1.5秒自动切换，增加趣味性

### 重试界面

- 清晰显示重试次数："已重试 X/3 次"
- 提供两个选择：
  - **重新分析**：继续尝试AI生成
  - **直接查看基础运势**：立即使用降级方案

### 降级提示

- 友好提示："已为您提供基础运势分析"
- 不会让用户感觉到功能缺失

## 🔄 API接口说明

### 获取今日运势

```http
GET /fortune/today
Authorization: Bearer {jwt_token}
```

**成功响应**：

```json
{
  "success": true,
  "data": {
    "overallScore": 85,
    "comment": "AI生成的运势分析...",
    "careerLuck": 80,
    "wealthLuck": 90,
    "loveLuck": 85,
    "luckyColor": "金色",
    "luckyNumber": 6,
    "suggestion": "AI生成的建议..."
  }
}
```

**AI失败响应**：

```json
{
  "success": false,
  "message": "AI生成失败，请重试",
  "code": "AI_FAILED"
}
```

### 重新生成运势

```http
POST /fortune/today/regenerate
Authorization: Bearer {jwt_token}
```

## 🧪 测试指南

### 运行集成测试

```bash
cd apps/api
node scripts/test-ai-integration.js
```

### 测试覆盖范围

- ✅ AI服务状态检查
- ✅ 运势生成API测试
- ✅ 重试机制测试
- ✅ 降级机制验证

### 手动测试场景

1. **正常流程**：配置有效AI密钥，测试正常生成
2. **AI失败**：使用无效密钥，测试重试界面
3. **网络超时**：模拟网络问题，测试超时处理
4. **多次重试**：连续重试3次，测试自动降级

## 🎯 场景覆盖

### 预览版运势（不使用AI）

- 场景1：新访客触碰已绑定手链
- 场景3：新访客直接进入
- 场景4：已认证用户触碰他人手链
- 特殊场景：信息不完整用户

### 完整版运势（可使用AI）

- 场景2：新访客触碰未绑定手链（绑定后）
- 场景5：已认证用户触碰未绑定手链
- 场景6：已认证用户触碰自己手链
- 场景7：已认证用户直接进入

## 📊 监控指标

### 性能指标

- **响应时间**：目标 < 6.5秒（包含AI调用）
- **AI成功率**：目标 > 90%
- **用户重试率**：监控 < 10%

### 日志记录

- AI调用成功/失败日志
- 用户重试行为日志
- 降级使用情况日志

## 🔍 故障排查

### 常见问题

**Q: AI一直生成失败？**
A: 检查API密钥和网络连接，确认AI服务可用性

**Q: 重试按钮无响应？**
A: 检查前端API调用和后端regenerate接口

**Q: 降级运势内容不合适？**
A: 修改 `loadFallbackFortune()` 函数中的固定模板

### 调试步骤

1. 检查环境变量配置
2. 运行AI服务测试脚本
3. 查看后端日志输出
4. 检查前端网络请求

## 🚀 部署建议

### 生产环境

- 使用稳定的AI服务提供商
- 配置适当的超时时间
- 启用详细的监控日志
- 准备降级方案的优质内容

### 性能优化

- 考虑添加Redis缓存
- 实施AI调用频率限制
- 监控AI服务响应时间
- 优化Prompt模板

## 📝 更新日志

### v1.0.0 (2025-01-26)

- ✅ 完成AI服务集成
- ✅ 实现智能重试机制
- ✅ 添加优雅降级功能
- ✅ 支持8个用户场景
- ✅ 完善前端交互界面

---

**注意**：本功能已完成开发和基础测试，建议在生产环境部署前进行充分的压力测试和用户体验测试。
