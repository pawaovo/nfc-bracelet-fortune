# Story 1.3: 已认证用户 - NFC 触碰查看运势 (核心体验)

## Status

Draft

## Story

**As a** 已绑定手链的用户,
**I want** 通过手机触碰我的手链,
**so that** 可以直接、快速地看到我当天的完整专属运势，体现手链的价值感和便捷性.

## Acceptance Criteria

1.  当已认证用户使用手机触碰**自己已绑定**的任一手链时，小程序能自动启动。
2.  后台能通过传入的 NFC ID 准确识别用户身份，并完成静默登录流程 (`POST /api/v1/auth/login` 返回 `AUTHENTICATED` 状态)。
3.  无需用户进行任何点击或输入操作，直接跳转并展示**完整版**的“每日运势结果页” (`pages/fortune/index`)。
4.  完整版结果页顶部正确显示当天日期（例如：“2025年10月24日”）。
5.  结果页显示个性化欢迎语，格式为：“[用户称呼], 这是你的专属运势”。
6.  结果页清晰、突出地展示当日“综合分数”，例如“综合分数：88分”。
7.  结果页展示一句话的运势点评。
8.  结果页使用星级或其他可视化方式清晰展示各项分项运势（事业运、财富运、爱情运）。
9.  结果页清晰展示开运提示文字（今日喜用、幸运色、宜）。
10. 页面加载迅速，NFC 拉起至展示结果页的总时长应符合 NFR1.1 的要求 (小于 2 秒)。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 处理 NFC 启动与自动登录 (AC: 1, 2, 3)**
  - [ ] 在 `App.vue` 的 `onLaunch` (或相关全局逻辑) 中，检测小程序启动参数是否包含 `nfcId`。
  - [ ] 如果包含 `nfcId`，立即调用 `uni.login()` 获取 `code`。
  - [ ] 调用 API 服务 (`api/auth.ts`) 的 `login` 函数，发送 `code` 和 `nfcId` 到后端 `/api/v1/auth/login`。
  - [ ] 处理响应：
    - 如果 `status` 为 `AUTHENTICATED`，存储 `token` 和 `user` 信息 (到 Pinia store)，然后使用 `uni.redirectTo` 直接跳转到 `pages/fortune/index`。
    - 如果 `status` 为 `PROFILE_INCOMPLETE`，存储 `token`，跳转到 `pages/profile/index`。
    - 如果 `status` 为 `VISITOR_PREVIEW`，不存储 `token`，跳转到 `pages/fortune/index` 并标记为访客模式（见 Story 3.3）。
    - 处理可能的错误情况并给出提示。
- [ ] **Task 2: (后端) 完善 `/auth/login` 接口逻辑 (AC: 2)**
  - [ ] 确保 `/auth/login` 接口在接收到 `code` 和 `nfcId` 时：
    - 能正确调用微信 API 获取 `openid`。
    - 能通过 `nfcId` 在 `bracelets` 表中查找到对应的 `userId`。
    - 能通过 `openid` 在 `users` 表中查找到用户记录。
    - **关键验证**: 比较 `bracelets` 记录的 `userId` 与 `users` 记录的 `id` 是否匹配。
    - 如果匹配且用户信息完整，返回 `status: AUTHENTICATED`, `token`, `user` 信息。
    - 如果匹配但用户信息不完整（理论上不应发生在此流程，但在绑定流程发生），返回 `PROFILE_INCOMPLETE`。
    - 如果不匹配（NFC ID 存在但 OpenID 不符），返回 `status: VISITOR_PREVIEW`。
- [ ] **Task 3: (前端) 创建每日运势结果页 (`pages/fortune/index`) 基础结构 (AC: 3, 4, 5)**
  - [ ] 创建 `apps/wx-app/src/pages/fortune/index.vue`。
  - [ ] 在 `pages.json` 中注册页面。
  - [ ] 实现页面基本布局，包括顶部日期显示区域、欢迎语区域（动态显示用户名）。
  - [ ] 在 `onLoad` 或 `onShow` 中检查 Pinia store 中的登录状态 (`token` 和 `user` 信息)。如果未登录，则跳转到登录/绑定流程（异常情况处理）。
  - [ ] 在 `onLoad` 或 `onShow` 中触发获取今日运势的数据请求。
- [ ] **Task 4: (前端) 实现获取并展示今日运势数据 (AC: 4-9)**
  - [ ] 创建 API 服务函数 (`api/fortune.ts`) 用于调用 `GET /api/v1/fortune/today`，需携带 JWT Token。
  - [ ] 在 `pages/fortune/index.vue` 中调用此 API 函数获取数据。
  - [ ] 创建/使用 Pinia store (`stores/fortune.ts`) 存储运势数据（可选，也可直接存页面 data）。
  - [ ] 将获取到的日期、用户名、综合分数、点评、分项运势、开运提示等数据绑定到页面模板上进行展示。
  - [ ] 实现星级评分组件 (`components/StarRating.vue` 或使用 uView UI 组件) 用于展示分项运势。
  - [ ] 确保所有数据项都清晰可见（因为这是已认证用户视图）。
  - [ ] 添加加载状态 (Loading indicator) 处理数据请求过程。
  - [ ] 处理 API 请求失败的情况，显示错误提示。
- [ ] **Task 5: (后端) 实现 `GET /fortune/today` 接口 (AC: 4-9)**
  - [ ] 在 `apps/api` 创建 `FortunesModule`。
  - [ ] 创建 `FortunesController`，定义 `GET /fortune/today` 路由，并使用 `@UseGuards(AuthGuard('jwt'))` 保护。
  - [ ] 创建 `FortunesService`，实现获取今日运势的逻辑：
    - 从 JWT payload 获取 `userId`。
    - 查询 `users` 表获取用户信息（称呼、生日）。
    - 获取当前日期 (服务器时区)。
    - 查询 `daily_fortunes` 表看今天是否已有记录 (`userId`, `today`)。
    - **如果已有记录**: 直接返回数据库中的运势数据。
    - **如果没有记录**:
      - 执行运势计算逻辑 (基于用户生日、日期等)。**需要定义/实现此核心算法**。
      - (可选) 调用 OpenAI 兼容 API 获取运势点评或建议文本。
      - 将计算/生成的结果存入 `daily_fortunes` 表。
      - 返回新生成的运势数据。
    - 查询 `products` 表，根据推荐规则（待定）选择一个推荐商品。
    - 组合运势数据 (`fortune`)、推荐商品数据 (`recommendation`) 和认证状态 (`isAuth: true`) 返回给前端。
- [ ] **Task 6: 性能优化与验证 (AC: 10)**
  - [ ] 检查前后端代码，确保没有明显的性能瓶颈。
  - [ ] 确保数据库查询有合适的索引。
  - [ ] (手动) 测试 NFC 拉起到页面完全显示的端到端时间，确保在 2 秒内。

## Dev Notes

- **前端**:
  - **核心页面**: `apps/wx-app/src/pages/fortune/index.vue`。
  - **全局逻辑**: NFC 启动检测和自动登录逻辑可能放在 `App.vue` 或全局 mixin/hook 中。
  - **状态**: 使用 Pinia store (`stores/auth.ts`, `stores/user.ts`, `stores/fortune.ts`) 管理登录状态、用户信息和运势数据。
  - **API 调用**: `api/auth.ts`, `api/fortune.ts`。
  - **组件**: 可能需要 `StarRating.vue` 等子组件。
- **后端**:
  - **核心模块**: `FortunesModule`, `AuthModule`, `UsersModule` in `apps/api/src/`。
  - **核心接口**: `POST /auth/login`, `GET /fortune/today`。
  - **运势算法**: 需要明确或实现运势计算的核心逻辑。如果依赖 AI，需要实现 OpenAI API 调用和 Prompt 设计。
  - **数据库**: 涉及 `users`, `bracelets`, `daily_fortunes`, `products` 表的查询和写入。
  - **缓存**: 考虑为 `/fortune/today` 接口添加缓存（如 Redis），避免重复计算或查询。
- **共享**: 使用 `shared-types` 定义 API 响应和 Pinia store 中的数据结构。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试 `pages/fortune/index.vue` 在不同运势数据下的渲染。
  - 测试欢迎语、日期、分数、星级、提示的正确显示。
  - Mock Pinia store 和 API 服务调用。
  - 测试加载状态和错误状态的处理。
  - 测试全局启动逻辑中处理 NFC 参数和自动登录的部分。
- **后端单元测试 (Jest)**:
  - 测试 `FortunesService` 获取今日运势的逻辑：
    - 数据库已有记录的场景。
    - 数据库无记录，需要计算/生成并存储的场景。
    - (如果调用 AI) Mock OpenAI API 客户端。
    - 测试推荐商品的选择逻辑 (如果已定义)。
  - Mock Prisma Client。
  - 测试 `FortunesController` 的路由处理、守卫应用。
- **集成测试 (后端)**:
  - 测试 `GET /fortune/today` 接口：
    - 使用有效 JWT Token，验证返回的数据结构和内容是否正确 (包括首次生成和后续查询)。
    - 测试接口是否能正确处理数据库无记录的情况。
    - 测试接口与数据库的交互。
- **手动/E2E 测试 (uts)**:
  - **核心流程**: 使用已绑定的手链触碰手机，验证是否能快速、直接地展示完整的今日运势页面。
  - **数据验证**: 验证页面显示的运势数据是否准确、完整。
  - **性能**: 多次测试 NFC 拉起到页面加载完成的时间。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
