# Story 3.2: 查看特定日期的历史运势详情

## Status

Draft

## Story

**As a** 已认证用户,
**I want** 在历史运势列表页点击任意一条记录,
**so that** 可以跳转回结果页查看那一天的完整运势详情.

## Acceptance Criteria

1.  “历史运势列表页” (`pages/history/index`) 中的每一行记录都是可点击的。
2.  点击列表中的某一行后，页面跳转回“每日运势结果页” (`pages/fortune/index`)。
3.  跳转后的“每日运势结果页”展示的是用户所点击日期的**历史**运势数据，而不是当天的数据。
4.  页面顶部显示的日期应为所选历史日期。
5.  页面展示的欢迎语、综合分数、一句话点评、分项运势、开运提示等，均应为所选历史日期的数据。
6.  在展示历史数据的“每日运势结果页”上，“查看历史”按钮的功能应调整为返回历史列表页，或提供其他返回路径。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 实现历史列表项点击跳转 (AC: 1, 2)**
  - [ ] 在 `pages/history/index.vue` 中，为列表项（`v-for` 或 `wx:for` 循环的元素）添加点击事件 `@click="handleItemClick(item)"`。
  - [ ] 实现 `handleItemClick(item)` 函数：
    - 获取点击项的日期 `item.date`。
    - 使用 `uni.navigateTo` 跳转到 `pages/fortune/index`，并将日期作为参数传递，例如 `url: '/pages/fortune/index?date=' + item.date`。
- [ ] **Task 2: (前端) 修改运势结果页以支持显示历史数据 (AC: 3, 4, 5)**
  - [ ] 在 `pages/fortune/index.vue` 的 `onLoad` 生命周期函数中，检查 `options` 是否包含 `date` 参数。
  - [ ] **如果包含 `date` 参数**:
    - 将此日期存储到页面 data 中，标记为查看历史模式 (`isHistoryView: true`)。
    - 调用新的 API 服务函数 (`api/fortune.ts`) `getFortuneByDate(date)` 来获取指定日期的运势数据（而不是 `/fortune/today`）。
  - [ ] **如果不包含 `date` 参数**:
    - 标记为非历史模式 (`isHistoryView: false`)。
    - 继续执行原有的获取今日运势的逻辑 (`getTodayFortune`)。
  - [ ] 修改页面模板 (`<template>`)，确保日期、欢迎语、分数、点评、分项运势、开运提示等都绑定到从 API 获取的数据（无论是今日还是历史）。
- [ ] **Task 3: (前端) 调整历史视图下的导航 (AC: 6)**
  - [ ] 在 `pages/fortune/index.vue` 中，根据 `isHistoryView` 状态调整“查看历史”按钮的行为：
    - **如果 `isHistoryView` 为 `true`**: 将按钮文案改为“返回列表”或类似，点击事件 `handleHistoryClick` 应改为调用 `uni.navigateBack()` 返回上一页（即历史列表页）。
    - **如果 `isHistoryView` 为 `false`**: 保持原有的跳转到历史列表页的功能。
- [ ] **Task 4: (后端) 实现获取指定日期运势接口 (AC: 3, 5)**
  - [ ] 在 `FortunesModule` (`apps/api`) 中，`FortunesController` 定义 `GET /fortune/:date` 路由，并使用 `@UseGuards(AuthGuard('jwt'))` 保护。
  - [ ] 添加 `@Param('date')` 装饰器接收路径参数 `date`，并使用管道 (Pipe) 或 Service 层逻辑校验日期格式 (YYYY-MM-DD)。
  - [ ] 在 `FortunesService` 中实现 `getFortuneByDate` 方法：
    - 从 JWT payload 获取 `userId`。
    - 使用 Prisma Client 查询 `daily_fortunes` 表，条件为 `userId` 和传入的 `date`。
    - **如果找到记录**: 返回该记录的完整运势数据。同时，需要查询并附加**该历史日期**对应的推荐商品（`Product`）。
    - **如果未找到记录**: 返回 404 Not Found 错误 (`NotFoundException`)。
  - [ ] 确保接口响应的数据结构与 `/fortune/today` 返回的 `fortune` 和 `recommendation` 结构一致。

## Dev Notes

- **前端**:
  - **核心页面**: `pages/fortune/index.vue` 需要进行较大修改以支持两种模式（今日/历史）。`pages/history/index.vue` 需要添加跳转逻辑。
  - **路由传参**: 通过 `uni.navigateTo` 的 `url` query 参数传递日期。
  - **API 调用**: 需要新增 `getFortuneByDate` 函数 (`api/fortune.ts`) 调用 `GET /api/v1/fortune/:date`。
  - **状态**: `pages/fortune/index.vue` 需要引入 `isHistoryView` 状态来区分模式并调整 UI/行为。
- **后端**:
  - **核心接口**: 需要新增 `GET /api/v1/fortune/:date` 接口，实现认证、参数校验、按日期查询运势和对应推荐商品的逻辑。
  - **数据库**: 主要查询 `daily_fortunes` 和 `products` 表。确保 `(user_id, date)` 索引存在。
- **数据一致性**: `GET /fortune/:date` 返回的 `fortune` 和 `recommendation` 结构应与 `GET /fortune/today` 保持一致，以便前端复用渲染逻辑。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试 `pages/history/index.vue` 的 `handleItemClick` 函数是否正确使用日期参数跳转。
  - 测试 `pages/fortune/index.vue` 的 `onLoad` 函数：
    - 在有 `date` 参数时，是否设置 `isHistoryView: true` 并调用 `getFortuneByDate`。
    - 在无 `date` 参数时，是否设置 `isHistoryView: false` 并调用 `getTodayFortune`。
  - Mock `getFortuneByDate` API 调用，测试页面在历史模式下是否正确渲染日期、运势数据。
  - 测试在历史模式下，“查看历史”按钮是否变为“返回列表”且功能正确。
- **后端单元测试 (Jest)**:
  - 测试 `FortunesService` 的 `getFortuneByDate` 方法：
    - Mock Prisma Client (`dailyFortune.findUnique`)，验证查询条件 (`userId`, `date`)。
    - 测试找到记录时返回正确数据。
    - 测试未找到记录时抛出 `NotFoundException`。
    - 测试关联推荐商品的查询逻辑。
  - 测试 `FortunesController` 的 `GET /fortune/:date` 方法，包括守卫、参数接收/校验、Service 调用。
- **集成测试 (后端)**:
  - 测试 `GET /fortune/:date` 接口：
    - 使用有效 JWT Token 和存在的历史日期，验证返回 200 和正确的运势及推荐商品数据。
    - 使用有效 JWT Token 和不存在的历史日期，验证返回 404。
    - 使用无效 Token，验证返回 401。
    - 使用无效日期格式，验证返回 400。
- **手动/E2E 测试 (uts)**:
  - **核心流程**: 在历史列表页，点击任意一条记录，验证是否跳转到结果页，并且页面显示的是**对应历史日期**的完整运势信息（日期、分数、详情、推荐商品）。
  - **导航**: 验证在历史详情页，点击“返回列表”按钮是否能正确返回历史列表页。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
