# Story 1.2: 个人信息补全

## Status

Draft

## Story

**As a** 刚完成绑定的用户,
**I want** 在信息补全页输入我的称呼和生日,
**so that** 提交并保存这些信息，让系统为我生成个性化的运势.

## Acceptance Criteria

1.  从绑定流程成功完成后 (即 `/auth/login` 返回 `PROFILE_INCOMPLETE`)，正确展示“个人信息补全页” (`pages/profile/index`)。
2.  “个人信息补全页”包含指定的引导文案、称呼输入框、生日选择器（公历）、以及“开启我的好运”提交按钮。
3.  称呼输入框具有指定的标签“称呼”和占位符文字“请输入你的常用称呼”。
4.  生日选择器具有指定的标签“生日”、占位符文字“请选择你的生日”和日历图标，点击后能弹出日期选择控件供用户选择公历生日。
5.  点击“开启我的好运”按钮时，前端对“称呼”和“生日”进行非空校验。
6.  校验通过后，将用户输入的“称呼”和选择的“生日”数据发送给后端 (`PUT /api/v1/profile`)，后端成功将其与当前用户账户关联并保存。
7.  信息保存成功后，页面自动跳转至“每日运势结果页” (`pages/fortune/index`)。
8.  若信息保存失败，应停留在当前页并给出相应提示 (`uni.showToast`)。

## Tasks / Subtasks

- [ ] **Task 1: 创建个人信息补全页 (AC: 1, 2, 3, 4)**
  - [ ] 创建 `apps/wx-app/src/pages/profile/index.vue` 文件。
  - [ ] 实现页面布局，包含引导文案、称呼 `input`、生日 `picker` (mode=date) 和提交按钮，样式参考 UI/UX 规范。
  - [ ] 使用 Vue 3 `ref` 或 `reactive` 绑定表单数据 (`name`, `birthday`)。
  - [ ] 在 `apps/wx-app/src/pages.json` 中注册此页面。
- [ ] **Task 2: 实现前端信息校验与提交 (AC: 5, 6, 7, 8)**
  - [ ] 在 `pages/profile/index.vue` 中，为提交按钮添加点击事件处理函数 `handleSubmitClick`。
  - [ ] 在 `handleSubmitClick` 中，实现 `name` 和 `birthday` 的非空校验逻辑。校验失败时使用 `uni.showToast` 提示。
  - [ ] 校验成功后，调用封装好的 API 请求服务 (`apps/wx-app/src/api/profile.ts` - 需创建)，向后端 `/api/v1/profile` 发送 PUT 请求，携带 `name` 和 `birthday` 数据，并在请求头中附加 `Authorization: Bearer <token>`。Token 从 `uni.getStorageSync` 获取。
  - [ ] 处理后端响应：
    - 成功 (HTTP 200)，使用 `uni.redirectTo` 跳转到 `pages/fortune/index`。
    - 失败 (e.g., HTTP 400, 500)，使用 `uni.showToast` 显示错误提示。
- [ ] **Task 3: (后端) 创建 `/profile` 更新接口 (AC: 6)**
  - [ ] 在 `apps/api` 中创建 `ProfileModule` (或在 `UserModule` 中实现)。
  - [ ] 创建 DTO (`UpdateProfileDto.ts`) 用于接收和验证 `name` (string) 和 `birthday` (date string)。
  - [ ] 创建 `ProfileController` (或 `UserController`)，定义 `PUT /profile` 路由。
  - [ ] 使用 `@UseGuards(AuthGuard('jwt'))` 或类似守卫保护该路由，确保用户已认证。
  - [ ] 在 `ProfileService` (或 `UserService`) 中实现更新逻辑：
    - 从 JWT payload 中获取 `userId`。
    - 使用 Prisma Client 更新 `users` 表中对应 `userId` 记录的 `name` 和 `birthday` 字段。
    - 返回更新后的用户信息。
  - [ ] 配置全局 `ValidationPipe` 或在 Controller 方法参数中使用 `@Body(ValidationPipe)` 进行 DTO 验证。

## Dev Notes

- **前端**:
  - **页面**: `apps/wx-app/src/pages/profile/index.vue`。
  - **API 调用**: 需要创建 `src/api/profile.ts` 并实现 `updateProfile` 函数，确保携带 JWT Token。
  - **日期格式**: 生日选择器获取的日期格式 (YYYY-MM-DD) 需要与后端 API 要求的格式一致。
  - **状态**: 无需复杂的页面状态管理，使用 Vue 3 `ref` 即可。
- **后端**:
  - **模块**: `ProfileModule` / `UserModule` in `apps/api/src/`。
  - **DTO**: `UpdateProfileDto.ts` 用于验证输入。
  - **Service**: 实现数据库更新逻辑，使用 Prisma。
  - **认证**: 确保 `/profile` 路由受 JWT 守卫保护。
  - **数据库**: 涉及 `users` 表的更新操作。
- **共享**: 无需 `shared-types`，但后端 DTO 应与前端发送的数据结构匹配。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试页面的渲染，包括引导文案、标签、占位符。
  - 测试表单输入的双向绑定。
  - 测试日期选择器的交互（模拟）。
  - Mock `uni.request`, `uni.redirectTo`, `uni.showToast`, `uni.getStorageSync`。
  - 测试 `handleSubmitClick` 的校验逻辑（空值、格式）。
  - 测试 `handleSubmitClick` 在 API 调用成功和失败时的行为（跳转、提示）。
- **后端单元测试 (Jest)**:
  - 测试 `ProfileService` 的 `updateProfile` 方法。
  - Mock Prisma Client (`user.update`)，验证调用参数和返回值。
  - 测试 `ProfileController` 的 `PUT /profile` 方法，包括 DTO 验证、守卫应用、Service 调用。
  - Mock `AuthGuard` 和 `ProfileService`。
- **集成测试 (后端)**:
  - 测试 `PUT /profile` 接口：
    - 使用有效的 JWT Token 发送请求，验证数据库记录是否正确更新。
    - 使用无效/过期的 Token 发送请求，验证是否返回 401。
    - 发送无效数据（如 name 为空，birthday 格式错误），验证是否返回 400 校验错误。
- **手动测试**:
  - 完整测试从绑定成功跳转到补全页，填写信息并成功提交跳转到结果页的流程。
  - 测试不填写称呼或生日时的校验提示。
  - 测试选择生日的操作是否流畅。
  - 测试提交失败时的错误提示。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
