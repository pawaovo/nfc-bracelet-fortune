# Story 2.3: 商品推荐与跳转抖音店铺

## Status

Draft

## Story

**As a** 小程序用户（无论是否已认证）,
**I want** 在每日运势结果页看到推荐的开运手链，并能方便地跳转（复制链接）到抖音店铺查看或购买,
**so that** 发现可能适合我的开运商品并完成购买转化.

## Acceptance Criteria

1.  在每日运势结果页 (`pages/fortune/index`) 下方，正确展示“今日开运手链推荐”模块（访客版和完整版均需展示）。
2.  推荐模块包含手链图片、手链名称（如：“蓝宝石手链”）和一句话推荐语（如：“五行属水，完美契合...”）。
3.  推荐模块的手链数据来源于后端接口 (`GET /api/v1/fortune/today` 返回的 `recommendation` 字段)，并根据后台配置的规则进行展示。
4.  模块下方包含一个行动号召按钮，对于已认证用户 (`isAuth: true`)，文案为“去抖音店铺看看”；对于新访客 (`isAuth: false`)，文案强化为“购买手链，解锁完整运势”。
5.  点击此按钮后，成功将后端接口返回的推荐商品对应的抖音店铺链接 (`recommendation.douyinLink`) 复制到用户剪贴板。
6.  复制成功后，小程序应给出明确的提示信息 (`uni.showToast`)，告知用户链接已复制，可前往抖音 App 打开。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 实现商品推荐模块 UI (AC: 1, 2)**
  - [ ] 在 `pages/fortune/index.vue` 页面底部添加商品推荐模块的布局。
  - [ ] 实现模块标题、图片展示（使用 `image` 组件）、商品名称和描述文本的显示。
  - [ ] 图片加载失败时应有占位符或提示。
  - [ ] 样式需符合整体 UI 风格。
- [ ] **Task 2: (前端) 实现推荐按钮及复制链接功能 (AC: 4, 5, 6)**
  - [ ] 在商品推荐模块下方添加按钮。
  - [ ] 按钮文案需根据 `isAuth` 状态动态显示（"去抖音店铺看看" 或 "购买手链，解锁完整运势"）。
  - [ ] 为按钮绑定点击事件 `handleShopClick`。
  - [ ] 实现 `handleShopClick` 函数：
    - 从页面 data/Pinia store 中获取推荐商品的 `douyinLink`。
    - 调用 `uni.setClipboardData({ data: douyinLink })`。
    - 在 `success` 回调中使用 `uni.showToast({ title: '抖音店铺链接已复制，请打开抖音查看', icon: 'none' })`。
    - 在 `fail` 回调中给出错误提示。
  - [ ] (辅助函数) 可以将复制链接和提示的逻辑封装成一个可复用的 `copyDouyinLink` 函数，供此按钮和 Story 2.2 的解锁按钮调用。
- [ ] **Task 3: (前端) 数据绑定与展示 (AC: 3)**
  - [ ] 确保 `pages/fortune/index.vue` 从 `GET /fortune/today` 接口获取数据后，能正确解析 `recommendation` 字段。
  - [ ] 将 `recommendation.imageUrl`, `recommendation.name`, `recommendation.description`, `recommendation.douyinLink` 绑定到 UI 模块对应的元素上。
  - [ ] 处理 `recommendation` 可能为空或不存在的情况（例如，隐藏推荐模块或显示默认状态）。
- [ ] **Task 4: (后端) 实现商品推荐逻辑 (AC: 3)**
  - [ ] 在 `FortunesService` (`GET /fortune/today` 的实现中) 添加查询推荐商品的逻辑。
  - [ ] **推荐规则**: 与产品/运营方确定具体的推荐规则（例如，基于运势分数范围、喜用元素或其他）。在 Service 中实现该规则。
  - [ ] **查询**: 根据规则查询 `products` 表，选择一个合适的商品。
  - [ ] **数据填充**: 确保 `douyinLink` 等必要信息已填充到 `products` 表中（可通过 Prisma Seed 或后台管理功能）。
  - [ ] 将查询到的 `Product` 对象包含在 `/fortune/today` 接口的响应体 `recommendation` 字段中。
  - [ ] 如果没有匹配的推荐商品，`recommendation` 字段可以返回 `null`。

## Dev Notes

- **前端**:
  - **核心页面**: `apps/wx-app/src/pages/fortune/index.vue`。
  - **数据**: 推荐商品数据 (`recommendation`) 来自 `/fortune/today` 接口的响应。
  - **交互**: 核心是按钮点击后调用 `uni.setClipboardData` 复制链接并给出提示。
  - **UI**: 确保推荐模块在访客版和认证用户版都能正确展示。
- **后端**:
  - **核心接口**: `GET /api/v1/fortune/today` 需要增加查询和返回推荐商品的逻辑。
  - **推荐逻辑**: 需要实现具体的商品推荐规则算法。
  - **数据**: 需要确保 `products` 表中有数据且包含有效的 `douyinLink`。种子数据脚本 (Story 1.0 Task 8) 应包含 `douyinLink` 占位符的填充。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试推荐模块在接收到不同 `recommendation` 数据（有数据、null）时的渲染情况。
  - 测试按钮文案是否根据 `isAuth` 状态正确显示。
  - Mock `uni.setClipboardData`, `uni.showToast`。
  - 测试 `handleShopClick` 函数是否正确获取链接、调用复制 API 并显示提示。
- **后端单元测试 (Jest)**:
  - 测试 `FortunesService` 中的商品推荐逻辑：
    - 验证不同输入条件下（不同运势分数等）是否能返回预期的推荐商品。
    - 测试无匹配商品时返回 `null` 的情况。
  - Mock Prisma Client (`product.findFirst` 或类似查询)。
- **集成测试 (后端)**:
  - 测试 `GET /fortune/today` 接口是否能正确返回包含 `recommendation` 字段的响应，且 `recommendation` 内容符合预期（基于数据库中的 `products` 数据和推荐规则）。
- **手动/E2E 测试 (uts)**:
  - **核心流程**:
    - 验证运势结果页（访客版和认证用户版）下方是否都展示了推荐模块。
    - 验证模块中的图片、名称、描述是否正确加载。
    - 验证按钮文案是否根据用户身份显示正确。
    - 点击按钮，验证是否弹出“链接已复制”的提示。
    - 打开抖音或其他 App，验证剪贴板中的链接是否正确。
  - **数据验证**: （需要后台配合）验证推荐的商品是否符合后台设定的规则。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
