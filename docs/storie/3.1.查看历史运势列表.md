# Story 3.1: 查看历史运势列表

## Status

Draft

## Story

**As a** 已认证用户,
**I want** 在每日运势结果页找到并进入“历史记录”页面,
**so that** 可以浏览我过去每天的运势概览.

## Acceptance Criteria

1.  已认证用户的“每日运势结果页” (`pages/fortune/index`) 上存在一个清晰可见的“查看历史”入口/按钮。
2.  新访客的“每日运势结果页”上，“查看历史”入口/按钮应置灰或隐藏。
3.  点击“查看历史”入口后，页面跳转至“历史运势列表页” (`pages/history/index`)。
4.  “历史运势列表页”的页面标题为“我的运势足迹”。
5.  页面包含一个可返回“每日运势结果页”的按钮或操作方式。
6.  页面展示一个可上下滚动的列表，按日期倒序排列用户的历史运势记录。
7.  列表中的每一行至少包含日期（如“YYYY-MM-DD”）和当日的综合分数（如“综合: XX分”）。 (可选补充信息：一句话点评或关键词)。
8.  列表支持无限滚动或分页加载，以处理大量历史数据，并有加载状态提示。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 添加“查看历史”入口 (AC: 1, 2)**
  - [ ] 在 `pages/fortune/index.vue` 中，仅当 `isAuth` 为 `true` 时，渲染“查看历史”按钮或链接。
  - [ ] 为该入口绑定点击事件 `handleHistoryClick`。
  - [ ] 实现 `handleHistoryClick` 函数，使用 `uni.navigateTo` 跳转到 `pages/history/index`。
- [ ] **Task 2: (前端) 创建历史运势列表页 (AC: 3, 4, 5)**
  - [ ] 创建 `apps/wx-app/src/pages/history/index.vue` 文件。
  - [ ] 在 `pages.json` 中注册页面，并设置导航栏标题为“我的运势足迹”。
  - [ ] 实现页面基本布局，包含一个 `scroll-view` 用于列表展示。
  - [ ] 确保页面有默认的返回按钮（uni-app 导航机制）。
- [ ] **Task 3: (前端) 实现获取并展示历史列表 (AC: 6, 7)**
  - [ ] 创建 API 服务函数 (`api/fortune.ts`) 用于调用 `GET /api/v1/fortune/history`，需携带 JWT Token，并支持 `page` 和 `limit` 参数。
  - [ ] 在 `pages/history/index.vue` 的 `onLoad` (或 `onShow`) 中调用此 API 函数获取第一页数据。
  - [ ] 在页面 data 中维护 `historyList`, `page`, `limit`, `isLoading`, `hasMore` 等状态。
  - [ ] 使用 `v-for` (或 `wx:for`) 渲染 `historyList` 数据，展示日期和综合分数。
- [ ] **Task 4: (前端) 实现滚动加载更多 (AC: 8)**
  - [ ] 为 `scroll-view` 绑定 `scrolltolower` 事件，触发 `loadMoreHistory` 函数。
  - [ ] 实现 `loadMoreHistory` 函数：检查 `isLoading` 和 `hasMore` 状态，若可加载，则增加 `page` 值，调用 API 获取下一页数据，并将结果追加到 `historyList` 中，更新 `hasMore` 状态。
  - [ ] 在列表底部根据 `isLoading` 和 `hasMore` 状态显示加载提示（"正在加载...", "没有更多了"）。
- [ ] **Task 5: (后端) 实现获取历史列表接口 (AC: 6, 7, 8)**
  - [ ] 在 `FortunesModule` (`apps/api`) 中，`FortunesController` 定义 `GET /fortune/history` 路由，并使用 `@UseGuards(AuthGuard('jwt'))` 保护。
  - [ ] 添加 `@Query()` 装饰器来接收 `page` (默认 1) 和 `limit` (默认 20) 参数，并进行校验（如使用 `ValidationPipe`）。
  - [ ] 在 `FortunesService` 中实现 `getHistory` 方法：
    - 从 JWT payload 获取 `userId`。
    - 使用 Prisma Client 查询 `daily_fortunes` 表，根据 `userId` 筛选，按 `date` 降序排列。
    - 实现分页逻辑 (使用 `skip` 和 `take` 或 `offset` 和 `limit`)。
    - 查询总记录数 (`count`) 以计算总页数和 `hasMore` 状态。
    - 返回包含 `items` (当前页数据列表，仅含概要信息如 date, score, comment), `total`, `page`, `limit`, `hasMore` 的对象。

## Dev Notes

- **前端**:
  - **核心页面**: `apps/wx-app/src/pages/history/index.vue`。
  - **入口**: “查看历史”按钮在 `pages/fortune/index.vue` (仅 `isAuth: true` 时显示)。
  - **API 调用**: 需要创建 `getHistory` 函数 (`api/fortune.ts`) 调用 `GET /api/v1/fortune/history` 并处理分页参数。
  - **状态管理**: 页面自身管理列表数据及分页状态 (`historyList`, `page`, `isLoading`, `hasMore`)。
  - **UI**: 列表项应简洁清晰，滚动加载体验要流畅。
- **后端**:
  - **核心接口**: `GET /api/v1/fortune/history`，需要实现认证、参数校验、分页查询逻辑。
  - **数据库**: 主要查询 `daily_fortunes` 表，需要分页和排序。确保 `(user_id, date)` 索引存在以优化性能。
  - **响应**: 遵循 API 规范 定义的包含分页信息的响应结构。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试 `pages/fortune/index.vue` 中“查看历史”按钮的条件渲染和点击跳转。
  - 测试 `pages/history/index.vue` 的初始渲染（标题、空列表）。
  - Mock API 服务 (`getHistory`)。
  - 测试加载第一页数据后的列表渲染。
  - 测试滚动到底部触发 `loadMoreHistory` 函数的调用。
  - 测试 `loadMoreHistory` 函数在不同状态 (`isLoading`, `hasMore`) 下的行为。
  - 测试加载多页数据后 `historyList` 的正确性。
- **后端单元测试 (Jest)**:
  - 测试 `FortunesService` 的 `getHistory` 方法。
  - Mock Prisma Client (`dailyFortune.findMany`, `dailyFortune.count`)，验证分页参数 (`skip`, `take`)、排序 (`orderBy`) 和过滤条件 (`where`) 是否正确传递。
  - 验证返回的数据结构是否符合预期（包含 `items`, `total`, `page`, `limit`, `hasMore`）。
  - 测试 `FortunesController` 的路由处理、守卫应用、查询参数接收和校验。
- **集成测试 (后端)**:
  - 测试 `GET /fortune/history` 接口：
    - 使用有效 JWT Token，验证返回的数据结构和内容是否正确。
    - 测试分页参数 (`page`, `limit`) 是否生效。
    - 测试排序是否正确（日期倒序）。
    - 测试 `hasMore` 字段在不同页数的返回值是否正确。
- **手动/E2E 测试 (uts)**:
  - **核心流程**: 作为已认证用户，在运势结果页找到并点击“查看历史”，验证历史列表页是否正确显示。
  - **数据验证**: 验证列表项显示的日期和分数是否与用户的历史数据一致（需要有历史数据）。
  - **交互**: 验证列表是否可以正常滚动，滚动到底部是否能加载更多数据（需要足够多的历史数据），验证“没有更多了”的提示。
  - **导航**: 验证能否从历史页返回结果页。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
