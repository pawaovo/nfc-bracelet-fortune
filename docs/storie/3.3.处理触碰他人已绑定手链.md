# Story 3.3: 处理触碰他人已绑定手链

## Status

Draft

## Story

**As a** 用户（无论是否已认证）,
**I want** 在触碰**他人已绑定**的手链时，看到一个受限的运势预览并被引导购买我自己的手链,
**so that** 保护他人隐私的同时，也给我一个了解和购买产品的机会.

## Acceptance Criteria

1.  当用户 A 使用手机触碰用户 B 的**已绑定**手链时，小程序能自动启动。
2.  后台能检测到传入的 NFC ID 已被绑定，但该 ID 关联的微信 OpenID 与当前用户 A 的微信 OpenID 不匹配 (`POST /api/v1/auth/login` 返回 `VISITOR_PREVIEW` 状态)。
3.  在此情况下，小程序应直接跳转展示**访客版**的“每日运势结果页” (`pages/fortune/index`)，且不需要用户输入个人信息。
4.  访客版结果页的展示内容与 Story 2.2 的 AC 2-6 一致（显示日期、访客欢迎语、仅综合分数可见、其他内容模糊/遮挡、有醒目的购买引导模块）。
5.  页面底部的商品推荐模块及按钮的展示和功能与 Story 2.3 的 AC 1-6 针对新访客的部分一致（引导购买并复制抖音链接）。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 处理 NFC 启动与访客预览状态 (AC: 1, 3)**
  - [ ] 复用或调整 `App.vue` (或全局入口) 的 NFC 启动逻辑 (同 Story 1.3 Task 1)。
  - [ ] 当调用 `/api/v1/auth/login` (携带 `code` 和 `nfcId`) 后，后端返回 `status: VISITOR_PREVIEW`。
  - [ ] 确认前端能正确处理此状态：不存储 `token`，直接使用 `uni.redirectTo` 跳转到 `pages/fortune/index`，并传递参数或设置 Pinia store 状态，明确告知 `pages/fortune/index` 页面当前是访客预览模式 (`isAuth: false`, 可能还需要一个 `isPreview: true` 标志以区分是否需要获取用户称呼)。
- [ ] **Task 2: (后端) 确认 `/auth/login` 接口访客预览逻辑 (AC: 2)**
  - [ ] 确认 Story 1.3 Task 2 中实现的 `/auth/login` 逻辑：当根据 `nfcId` 查找到 `bracelet` 记录，但其 `userId` 与根据 `code` 获取到的 `openid` 对应的 `user.id` **不匹配**时，返回 `status: VISITOR_PREVIEW` (不返回 `token`)。
- [ ] **Task 3: (前端) 实现访客预览版运势页 (AC: 4, 5)**
  - [ ] 在 `pages/fortune/index.vue` 中，实现访客版视图的渲染逻辑 (同 Story 2.2 Task 1)。
  - [ ] **关键调整**: 在访客预览模式下 (`isPreview: true`?)，欢迎语可能需要调整为通用文本，因为此时无法获取触碰者 A 的称呼（除非 `/auth/login` 在返回 `VISITOR_PREVIEW` 时也返回了 A 的部分信息，或前端在此模式下请求用户信息）。**需要确认欢迎语逻辑**。
  - [ ] 确保模糊/遮挡效果、解锁引导模块（包括复制链接功能）、商品推荐模块（包括复制链接功能）都按访客版要求展示 (同 Story 2.2 Task 2, Story 2.3 Task 1, 2)。
- [ ] **Task 4: (后端) 确保 `/fortune/today` 支持访客预览 (AC: 4, 5)**
  - [ ] 修改或确认 `GET /api/v1/fortune/today` 接口：
    - **认证**: 此接口目前需要 JWT 认证。对于 `VISITOR_PREVIEW` 状态，前端没有 `token`。需要调整策略：
      - **方案 A**: `/auth/login` 在返回 `VISITOR_PREVIEW` 时，同时返回一个**临时的、权限受限的 Token**，仅用于调用一次 `/fortune/today` 获取预览数据。
      - **方案 B**: 调整 `/fortune/today` 接口，允许在**无 Token** 但携带特定参数（如 `preview=true` 或通过某种 session 机制）时，返回一个通用的、非个性化的运势预览分数和推荐商品。
      - **方案 C**: `/auth/login` 在返回 `VISITOR_PREVIEW` 时，直接返回今日的通用预览分数和推荐商品，前端无需再调用 `/fortune/today`。**（暂定采用方案 C 以简化流程）**
  - [ ] **如果采用方案 C**:
    - 修改 `/auth/login` 接口：在判断为 `VISITOR_PREVIEW` 时，除了返回 status，还需要额外计算/获取一个通用的今日综合分数和一个推荐商品，并将其包含在响应中。
    - 前端在收到 `VISITOR_PREVIEW` 状态及附带的预览数据后，直接渲染访客版运势页，无需再调用 `/fortune/today`。

## Dev Notes

- **前端**:
  - **核心页面**: `pages/fortune/index.vue` 需要能处理访客预览状态 (`isPreview: true`?)。
  - **全局逻辑**: `App.vue` 启动时需正确处理 `/auth/login` 返回的 `VISITOR_PREVIEW` 状态，并传递必要信息给 `pages/fortune/index`。
  - **数据**: 如果采用方案 C，预览数据（分数、推荐商品）直接来自 `/auth/login` 响应；否则需要处理临时 Token 或特定参数调用 `/fortune/today`。
  - **欢迎语**: 需要确认访客预览模式下的欢迎语内容（是否显示触碰者 A 的名字）。
- **后端**:
  - **核心接口**: `/api/v1/auth/login` 需要实现访客预览逻辑（NFC ID 与 OpenID 不匹配）。
  - **数据返回 (方案 C)**: 在返回 `VISITOR_PREVIEW` 时，需要额外包含通用的今日分数和推荐商品信息。
- **流程 (方案 C)**: 用户 A 触碰 B 手链 -> `wx.login()` -> `/auth/login` (带 code, nfcId) -> 后端检测不匹配 -> 返回 `{ status: VISITOR_PREVIEW, previewScore: XX, recommendation: {...} }` -> 前端跳转 `pages/fortune/index` -> 渲染访客版，使用 `previewScore` 和 `recommendation` 数据。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试 `App.vue` 启动逻辑在 `/auth/login` 返回 `VISITOR_PREVIEW` 时的跳转行为和数据传递。
  - 测试 `pages/fortune/index.vue` 在访客预览模式下的渲染（使用模拟数据），包括欢迎语、分数、模糊效果、引导模块、推荐模块。
- **后端单元测试 (Jest)**:
  - 重点测试 `AuthService` 处理 `nfcId` 与 `openid` 不匹配的情况，验证是否返回 `VISITOR_PREVIEW`。
  - (如果采用方案 C) 验证返回 `VISITOR_PREVIEW` 时是否包含 `previewScore` 和 `recommendation` 数据。
  - Mock Prisma Client 和 WeChat API 调用。
- **集成测试 (后端)**:
  - 测试 `/auth/login` 接口：使用一个 `code` 和一个**已绑定给其他用户**的 `nfcId` 调用，验证是否返回 `VISITOR_PREVIEW` 状态（以及方案 C 下的附带数据）。
- **手动/E2E 测试 (uts)**:
  - **核心流程**: 使用手机 A 登录小程序，再用手机 A 触碰一个**已绑定给用户 B** 的手链，验证是否直接进入**访客预览版**运势页（模糊、有引导）。
  - **数据验证**: 验证显示的分数是否为预期的通用预览分数（如果采用方案 C）。
  - **交互**: 验证解锁引导和商品推荐的复制链接功能是否正常。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
