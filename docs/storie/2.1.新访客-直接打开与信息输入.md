# Story 2.1: 新访客 - 直接打开与信息输入

## Status

Draft

## Story

**As a** 对小程序感兴趣但没有手链的新访客,
**I want** 在直接打开小程序时，被引导输入我的称呼和生日信息,
**so that** 可以获取我的运势预览.

## Acceptance Criteria

1.  当未绑定手链的用户首次直接打开小程序时，小程序能正常启动。
2.  系统检测到用户为未绑定用户 (`POST /api/v1/auth/login` 仅使用 `code` 时返回 `PROFILE_INCOMPLETE` 状态)，引导进行微信授权。
3.  微信授权成功后 (获取到 `token`)，跳转至“个人信息补全页” (`pages/profile/index`)。
4.  “个人信息补全页”的展示和信息输入、保存流程与 Story 1.2 的 AC 2-8 完全一致。
5.  信息保存成功后 (`PUT /api/v1/profile` 成功)，页面跳转至**访客版**“每日运势结果页” (`pages/fortune/index` 且 `isAuth` 状态为 `false`)。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 处理新访客直接启动流程 (AC: 1, 2, 3)**
  - [ ] 复用或调整 `App.vue` (或全局入口) 的启动逻辑。
  - [ ] 当小程序直接启动 (无 `nfcId` 参数) 且调用 `/api/v1/auth/login` (仅带 `code`) 后，后端返回 `status: PROFILE_INCOMPLETE`。
  - [ ] 确认前端能正确处理此状态：存储返回的 `token` 和部分 `user` 信息 (到 Pinia store)，然后使用 `uni.redirectTo` 跳转到 `pages/profile/index`。
- [ ] **Task 2: (后端) 确认 `/auth/login` 接口新访客逻辑 (AC: 2)**
  - [ ] 确认 Story 1.4 Task 2 中实现的 `/auth/login` 逻辑：当根据 `openid` 在 `users` 表中**未找到**用户时，会创建新用户记录 (name/birthday 为 null) 并返回 `status: PROFILE_INCOMPLETE`, `token` 和新 `user` 信息。
- [ ] **Task 3: (前端) 复用个人信息补全页逻辑 (AC: 4)**
  - [ ] 确保 `pages/profile/index.vue` 页面及其逻辑 (如 Story 1.2 Task 1, 2 所述) 可以被新访客流程复用。
  - [ ] 确认 `handleSubmitClick` 函数在调用 `PUT /api/v1/profile` 成功后能正确跳转。
- [ ] **Task 4: (前端) 跳转至访客版运势页 (AC: 5)**
  - [ ] 调整 `pages/profile/index.vue` 的 `handleSubmitClick` 成功回调逻辑：在跳转到 `pages/fortune/index` 时，需要传递参数或设置 Pinia store 状态，告知 `pages/fortune/index` 页面当前用户身份是新访客（即使信息已补全但未绑定手链），因此应展示访客版 (`isAuth: false`)。 (或者，此状态由 `/fortune/today` 接口返回确定)。
- [ ] **Task 5: (后端) 确认 `/fortune/today` 接口能区分新访客 (AC: 5)**
  - [ ] 确认 `GET /api/v1/fortune/today` 接口（Story 1.3 Task 5 实现）在根据 Token 解析 `userId` 后，能检查该用户是否已绑定任何手链 (查询 `bracelets` 表)。
  - [ ] 如果用户未绑定任何手链，即使 `name` 和 `birthday` 已存在，接口也应返回 `{ ..., isAuth: false }`，并且 `fortune` 数据中仅包含访客可见的部分 (如 `score`)。运势计算逻辑可能需要调整以支持仅计算分数。

## Dev Notes

- **前端**:
  - **核心逻辑**: 复用 `App.vue` 启动流程和 `pages/profile/index.vue` 信息补全逻辑。关键在于正确处理 `/auth/login` 返回的 `PROFILE_INCOMPLETE` 状态，并在信息提交后确保跳转到的是**访客版**运势页。
  - **状态**: 需要明确一种方式告知 `pages/fortune/index` 当前是访客状态 (`isAuth: false`)。推荐由 `/fortune/today` 接口返回此状态标志。
- **后端**:
  - **核心接口**: `/auth/login` (处理新访客创建)，`/profile` (更新信息)，`/fortune/today` (根据用户绑定状态返回不同数据)。
  - **状态区分**: `/fortune/today` 必须能够区分**已补全信息但未绑定手链**的用户（应视为访客，`isAuth: false`）和**已绑定手链**的用户 (`isAuth: true`)。
- **流程**: 新访客直接打开 -> `wx.login()` -> `/auth/login` (返回 `PROFILE_INCOMPLETE`) -> 跳转 `pages/profile/index` -> 提交信息 (`PUT /profile`) -> 跳转 `pages/fortune/index` (加载访客版)。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试 `App.vue` 启动逻辑在 `/auth/login` 返回 `PROFILE_INCOMPLETE` 时的跳转行为。
  - 测试 `pages/profile/index.vue` 提交成功后是否正确触发跳转，并考虑如何模拟/验证目标页面的状态 (访客版)。
- **后端单元测试 (Jest)**:
  - 重点验证 Story 1.4 Task 2 中 `/auth/login` 处理新访客的逻辑是否正确（创建用户并返回 `PROFILE_INCOMPLETE`）。
  - 测试 `FortunesService` (`GET /fortune/today`) 在用户**未绑定手链**但**有个人信息**时，是否返回 `{ isAuth: false }` 和仅包含访客可见数据的 `fortune` 对象。
- **集成测试 (后端)**:
  - 测试完整流程：使用新用户的 `code` 调用 `/auth/login` -> 使用返回的 `token` 调用 `PUT /profile` -> 使用该 `token` 调用 `GET /fortune/today`，验证最后一步返回的数据符合访客版要求 (`isAuth: false` 等)。
- **手动/E2E 测试 (uts)**:
  - **核心流程**: 使用一个从未登录过的新微信账号，直接打开小程序，完成授权、信息输入，验证最终是否进入**访客版**运势结果页（模糊处理、有解锁引导）。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
