# Story 1.4: 已认证用户 - 直接打开查看运势

## Status

Draft

## Story

**As a** 已绑定手链的用户,
**I want** 直接从微信列表打开小程序时,
**so that** 也能自动识别我的身份并直接看到当天的完整运势，方便在不使用 NFC 时查看.

## Acceptance Criteria

1.  已认证用户从微信中直接打开小程序时，小程序能正常启动。
2.  系统能通过微信 OpenID 查询用户身份，并识别为已认证用户 (`POST /api/v1/auth/login` 仅使用 `code` 时返回 `AUTHENTICATED` 状态)，完成静默登录。
3.  无需用户进行任何点击或输入操作，直接跳转并展示**完整版**的“每日运势结果页” (`pages/fortune/index`)。
4.  完整版结果页展示的内容（日期、欢迎语、综合分数、点评、分项运势、开运提示）与 Story 1.3 的 AC 4-9 完全一致。
5.  页面加载迅速，符合 NFR1.2 的要求 (小于 3 秒)。

## Tasks / Subtasks

- [ ] **Task 1: (前端) 处理直接启动与自动登录 (AC: 1, 2, 3)**
  - [ ] 在 `App.vue` 的 `onLaunch` (或相关全局逻辑) 中，检测小程序启动参数**不包含** `nfcId` 的情况（即直接打开）。
  - [ ] 立即调用 `uni.login()` 获取 `code`。
  - [ ] 调用 API 服务 (`api/auth.ts`) 的 `login` 函数，发送 `code` (不带 `nfcId`) 到后端 `/api/v1/auth/login`。
  - [ ] 处理响应：
    - 如果 `status` 为 `AUTHENTICATED`，存储 `token` 和 `user` 信息 (到 Pinia store)，然后使用 `uni.redirectTo` 直接跳转到 `pages/fortune/index`。
    - 如果 `status` 为 `PROFILE_INCOMPLETE`，存储 `token`，跳转到 `pages/profile/index` (适用于新访客首次直接打开场景，见 Story 2.1)。
    - 如果 `status` 为 `VISITOR_PREVIEW` (理论上不带 nfcId 不会返回此状态，但需处理健壮性)，跳转访客页。
    - 处理可能的错误情况并给出提示。
- [ ] **Task 2: (后端) 完善 `/auth/login` 接口逻辑 (AC: 2)**
  - [ ] 确保 `/auth/login` 接口在**仅接收到** `code` (没有 `nfcId`) 时：
    - 能正确调用微信 API 获取 `openid`。
    - 能通过 `openid` 在 `users` 表中查找到用户记录。
    - **如果找到用户**:
      - 检查用户信息是否完整（`name` 和 `birthday` 是否存在）。
      - 如果信息完整，返回 `status: AUTHENTICATED`, `token`, `user` 信息。
      - 如果信息不完整，返回 `status: PROFILE_INCOMPLETE`, `token`, `user` 信息。
    - **如果未找到用户** (新访客直接打开):
      - 创建新的 `Users` 记录 (`openid`，`name` 和 `birthday` 为 null)。
      - 返回 `status: PROFILE_INCOMPLETE`, `token`, 新创建的 `user` 信息（部分为空）。
- [ ] **Task 3: (前端) 确保运势结果页能处理直接进入流程 (AC: 3, 4)**
  - [ ] 验证 `pages/fortune/index.vue` 在 `onLoad` 或 `onShow` 中能正确获取 Pinia store 中的登录状态和用户信息。
  - [ ] 确保页面能基于已登录状态自动触发 `GET /api/v1/fortune/today` 请求。
  - [ ] 确保页面能正确渲染从 API 获取的完整运势数据（同 Story 1.3 Task 4）。
- [ ] **Task 4: 性能验证 (AC: 5)**
  - [ ] (手动) 测试从微信列表点击小程序图标到 `pages/fortune/index` 页面完全显示的端到端时间，确保在 3 秒内。

## Dev Notes

- **前端**:
  - **核心逻辑**: 在 `App.vue` 或全局入口处理启动逻辑，区分有无 `nfcId` 参数的情况。
  - **API 调用**: 复用 `api/auth.ts` 的 `login` 函数，但不传递 `nfcId`。复用 `api/fortune.ts` 获取运势数据。
  - **状态**: 依赖 Pinia store (`stores/auth.ts`, `stores/user.ts`) 在启动时恢复和检查登录状态。
  - **页面**: 主要是复用 `pages/fortune/index.vue` 的逻辑。
- **后端**:
  - **核心接口**: `/api/v1/auth/login` 需要能处理不带 `nfcId` 的请求，并根据 `openid` 查询用户，判断状态返回 `AUTHENTICATED` 或 `PROFILE_INCOMPLETE`。
  - **数据库**: 涉及 `users` 表的查询（和可能的创建，针对新访客）。
- **流程**: 此故事主要复用 Story 1.3 的运势获取和展示逻辑，关键在于启动时的自动登录判断。
- **编码标准**: 遵循 `docs/architecture/coding-standards.md`。

## Testing

- **前端单元测试 (Vitest)**:
  - 测试全局启动逻辑中处理**无 nfcId** 参数的情况。
  - Mock `uni.login`, `uni.request`, `uni.redirectTo`, `uni.getStorageSync`。
  - 测试不同 `/auth/login` 响应 (`AUTHENTICATED`, `PROFILE_INCOMPLETE`) 下的页面跳转逻辑。
  - 测试 `pages/fortune/index.vue` 在 `onLoad/onShow` 时能正确检查登录态并发起请求。
- **后端单元测试 (Jest)**:
  - 重点测试 `AuthService` 处理**仅有 code** 的登录请求逻辑。
  - Mock Prisma Client (`user.findUnique`, `user.create`) 和 WeChat API 调用。
  - 验证对已存在且信息完整的用户返回 `AUTHENTICATED`。
  - 验证对已存在但信息不完整的用户返回 `PROFILE_INCOMPLETE`。
  - 验证对不存在的用户（新访客）创建记录并返回 `PROFILE_INCOMPLETE`。
- **集成测试 (后端)**:
  - 测试 `POST /auth/login` 接口（仅带 `code`）：
    - 使用已注册用户的 `code`，验证返回 `AUTHENTICATED` 和有效 `token`。
    - 使用新用户的 `code`，验证返回 `PROFILE_INCOMPLETE`，`token`，并在数据库创建了用户记录。
- **手动/E2E 测试 (uts)**:
  - **核心流程**: 从微信列表直接打开小程序，验证是否自动登录并直接显示完整的今日运势页面（对于已完成信息补全的用户）。
  - **性能**: 多次测试启动到页面加载完成的时间。

## Change Log

| Date           | Version | Description | Author |
| :------------- | :------ | :---------- | :----- |
| 2025年10月24日 | 0.1     | 初始草稿    | SM     |
